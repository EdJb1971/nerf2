(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Fn=Symbol("Comlink.proxy"),$r=Symbol("Comlink.endpoint"),qr=Symbol("Comlink.releaseProxy"),Dt=Symbol("Comlink.finalizer"),nt=Symbol("Comlink.thrown"),jn=t=>typeof t=="object"&&t!==null||typeof t=="function",Vr={canHandle:t=>jn(t)&&t[Fn],serialize(t){const{port1:e,port2:n}=new MessageChannel;return Kt(t,e),[n,[n]]},deserialize(t){return t.start(),Ur(t)}},zr={canHandle:t=>jn(t)&&nt in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},Bn=new Map([["proxy",Vr],["throw",zr]]);function Lr(t,e){for(const n of t)if(e===n||n==="*"||n instanceof RegExp&&n.test(e))return!0;return!1}function Kt(t,e=globalThis,n=["*"]){e.addEventListener("message",function r(s){if(!s||!s.data)return;if(!Lr(n,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:a,type:i,path:o}=Object.assign({path:[]},s.data),l=(s.data.argumentList||[]).map(ge);let u;try{const c=o.slice(0,-1).reduce((d,f)=>d[f],t),h=o.reduce((d,f)=>d[f],t);switch(i){case"GET":u=h;break;case"SET":c[o.slice(-1)[0]]=ge(s.data.value),u=!0;break;case"APPLY":u=h.apply(c,l);break;case"CONSTRUCT":{const d=new h(...l);u=Qr(d)}break;case"ENDPOINT":{const{port1:d,port2:f}=new MessageChannel;Kt(t,f),u=Xr(d,[d])}break;case"RELEASE":u=void 0;break;default:return}}catch(c){u={value:c,[nt]:0}}Promise.resolve(u).catch(c=>({value:c,[nt]:0})).then(c=>{const[h,d]=it(c);e.postMessage(Object.assign(Object.assign({},h),{id:a}),d),i==="RELEASE"&&(e.removeEventListener("message",r),Nn(e),Dt in t&&typeof t[Dt]=="function"&&t[Dt]())}).catch(c=>{const[h,d]=it({value:new TypeError("Unserializable return value"),[nt]:0});e.postMessage(Object.assign(Object.assign({},h),{id:a}),d)})}),e.start&&e.start()}function Hr(t){return t.constructor.name==="MessagePort"}function Nn(t){Hr(t)&&t.close()}function Ur(t,e){const n=new Map;return t.addEventListener("message",function(s){const{data:a}=s;if(!a||!a.id)return;const i=n.get(a.id);if(i)try{i(a)}finally{n.delete(a.id)}}),Ft(t,n,[],e)}function rt(t){if(t)throw new Error("Proxy has been released and is not useable")}function $n(t){return Ae(t,new Map,{type:"RELEASE"}).then(()=>{Nn(t)})}const st=new WeakMap,at="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(st.get(t)||0)-1;st.set(t,e),e===0&&$n(t)});function Gr(t,e){const n=(st.get(e)||0)+1;st.set(e,n),at&&at.register(t,e,t)}function Wr(t){at&&at.unregister(t)}function Ft(t,e,n=[],r=function(){}){let s=!1;const a=new Proxy(r,{get(i,o){if(rt(s),o===qr)return()=>{Wr(a),$n(t),e.clear(),s=!0};if(o==="then"){if(n.length===0)return{then:()=>a};const l=Ae(t,e,{type:"GET",path:n.map(u=>u.toString())}).then(ge);return l.then.bind(l)}return Ft(t,e,[...n,o])},set(i,o,l){rt(s);const[u,c]=it(l);return Ae(t,e,{type:"SET",path:[...n,o].map(h=>h.toString()),value:u},c).then(ge)},apply(i,o,l){rt(s);const u=n[n.length-1];if(u===$r)return Ae(t,e,{type:"ENDPOINT"}).then(ge);if(u==="bind")return Ft(t,e,n.slice(0,-1));const[c,h]=qn(l);return Ae(t,e,{type:"APPLY",path:n.map(d=>d.toString()),argumentList:c},h).then(ge)},construct(i,o){rt(s);const[l,u]=qn(o);return Ae(t,e,{type:"CONSTRUCT",path:n.map(c=>c.toString()),argumentList:l},u).then(ge)}});return Gr(a,t),a}function Yr(t){return Array.prototype.concat.apply([],t)}function qn(t){const e=t.map(it);return[e.map(n=>n[0]),Yr(e.map(n=>n[1]))]}const Vn=new WeakMap;function Xr(t,e){return Vn.set(t,e),t}function Qr(t){return Object.assign(t,{[Fn]:!0})}function it(t){for(const[e,n]of Bn)if(n.canHandle(t)){const[r,s]=n.serialize(t);return[{type:"HANDLER",name:e,value:r},s]}return[{type:"RAW",value:t},Vn.get(t)||[]]}function ge(t){switch(t.type){case"HANDLER":return Bn.get(t.name).deserialize(t.value);case"RAW":return t.value}}function Ae(t,e,n,r){return new Promise(s=>{const a=Jr();e.set(a,s),t.start&&t.start(),t.postMessage(Object.assign({id:a},n),r)})}function Jr(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var Zr=1e-6,L=typeof Float32Array<"u"?Float32Array:Array,es="zyx";function jt(){var t=new L(9);return L!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function zn(t,e,n,r,s,a,i,o,l){var u=new L(9);return u[0]=t,u[1]=e,u[2]=n,u[3]=r,u[4]=s,u[5]=a,u[6]=i,u[7]=o,u[8]=l,u}function ts(t,e){if(t===e){var n=e[1],r=e[2],s=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=s}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function ns(t,e,n){var r=e[0],s=e[1],a=e[2],i=e[3],o=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=n[0],f=n[1],v=n[2],y=n[3],m=n[4],g=n[5],p=n[6],w=n[7],_=n[8];return t[0]=d*r+f*i+v*u,t[1]=d*s+f*o+v*c,t[2]=d*a+f*l+v*h,t[3]=y*r+m*i+g*u,t[4]=y*s+m*o+g*c,t[5]=y*a+m*l+g*h,t[6]=p*r+w*i+_*u,t[7]=p*s+w*o+_*c,t[8]=p*a+w*l+_*h,t}function Bt(){var t=new L(16);return L!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Ln(t){var e=new L(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function rs(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Nt(t,e,n){var r=e[0],s=e[1],a=e[2],i=e[3],o=r+r,l=s+s,u=a+a,c=r*o,h=r*l,d=r*u,f=s*l,v=s*u,y=a*u,m=i*o,g=i*l,p=i*u;return t[0]=1-(f+y),t[1]=h+p,t[2]=d-g,t[3]=0,t[4]=h-p,t[5]=1-(c+y),t[6]=v+m,t[7]=0,t[8]=d+g,t[9]=v-m,t[10]=1-(c+f),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function $t(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function ss(t,e){var n=e[0],r=e[1],s=e[2],a=e[4],i=e[5],o=e[6],l=e[8],u=e[9],c=e[10];return t[0]=Math.sqrt(n*n+r*r+s*s),t[1]=Math.sqrt(a*a+i*i+o*o),t[2]=Math.sqrt(l*l+u*u+c*c),t}function qt(t,e){var n=new L(3);ss(n,e);var r=1/n[0],s=1/n[1],a=1/n[2],i=e[0]*r,o=e[1]*s,l=e[2]*a,u=e[4]*r,c=e[5]*s,h=e[6]*a,d=e[8]*r,f=e[9]*s,v=e[10]*a,y=i+c+v,m=0;return y>0?(m=Math.sqrt(y+1)*2,t[3]=.25*m,t[0]=(h-f)/m,t[1]=(d-l)/m,t[2]=(o-u)/m):i>c&&i>v?(m=Math.sqrt(1+i-c-v)*2,t[3]=(h-f)/m,t[0]=.25*m,t[1]=(o+u)/m,t[2]=(d+l)/m):c>v?(m=Math.sqrt(1+c-i-v)*2,t[3]=(d-l)/m,t[0]=(o+u)/m,t[1]=.25*m,t[2]=(h+f)/m):(m=Math.sqrt(1+v-i-c)*2,t[3]=(o-u)/m,t[0]=(d+l)/m,t[1]=(h+f)/m,t[2]=.25*m),t}function te(){var t=new L(3);return L!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function as(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}function ot(t,e,n){var r=new L(3);return r[0]=t,r[1]=e,r[2]=n,r}function is(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function os(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function ls(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function cs(t,e){var n=e[0],r=e[1],s=e[2],a=n*n+r*r+s*s;return a>0&&(a=1/Math.sqrt(a)),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}function us(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Vt(t,e,n){var r=e[0],s=e[1],a=e[2],i=n[0],o=n[1],l=n[2];return t[0]=s*l-a*o,t[1]=a*i-r*l,t[2]=r*o-s*i,t}function hs(t,e,n,r){var s=e[0],a=e[1],i=e[2];return t[0]=s+r*(n[0]-s),t[1]=a+r*(n[1]-a),t[2]=i+r*(n[2]-i),t}function Hn(t,e,n){var r=e[0],s=e[1],a=e[2];return t[0]=r*n[0]+s*n[3]+a*n[6],t[1]=r*n[1]+s*n[4]+a*n[7],t[2]=r*n[2]+s*n[5]+a*n[8],t}var ds=as;(function(){var t=te();return function(e,n,r,s,a,i){var o,l;for(n||(n=3),r||(r=0),s?l=Math.min(s*n+r,e.length):l=e.length,o=r;o<l;o+=n)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],a(t,t,i),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2];return e}})();function fs(){var t=new L(4);return L!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function ps(t){var e=new L(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function ms(t,e){var n=e[0],r=e[1],s=e[2],a=e[3],i=n*n+r*r+s*s+a*a;return i>0&&(i=1/Math.sqrt(i)),t[0]=n*i,t[1]=r*i,t[2]=s*i,t[3]=a*i,t}(function(){var t=fs();return function(e,n,r,s,a,i){var o,l;for(n||(n=4),r||(r=0),s?l=Math.min(s*n+r,e.length):l=e.length,o=r;o<l;o+=n)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],t[3]=e[o+3],a(t,t,i),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2],e[o+3]=t[3];return e}})();function Q(){var t=new L(4);return L!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function ys(t,e,n){n=n*.5;var r=Math.sin(n);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(n),t}function gs(t,e,n){var r=e[0],s=e[1],a=e[2],i=e[3],o=n[0],l=n[1],u=n[2],c=n[3];return t[0]=r*c+i*o+s*u-a*l,t[1]=s*c+i*l+a*o-r*u,t[2]=a*c+i*u+r*l-s*o,t[3]=i*c-r*o-s*l-a*u,t}function je(t,e,n,r){var s=e[0],a=e[1],i=e[2],o=e[3],l=n[0],u=n[1],c=n[2],h=n[3],d,f,v,y,m;return f=s*l+a*u+i*c+o*h,f<0&&(f=-f,l=-l,u=-u,c=-c,h=-h),1-f>Zr?(d=Math.acos(f),v=Math.sin(d),y=Math.sin((1-r)*d)/v,m=Math.sin(r*d)/v):(y=1-r,m=r),t[0]=y*s+m*l,t[1]=y*a+m*u,t[2]=y*i+m*c,t[3]=y*o+m*h,t}function vs(t,e){var n=e[0],r=e[1],s=e[2],a=e[3],i=n*n+r*r+s*s+a*a,o=i?1/i:0;return t[0]=-n*o,t[1]=-r*o,t[2]=-s*o,t[3]=a*o,t}function Un(t,e){var n=e[0]+e[4]+e[8],r;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);var a=(s+1)%3,i=(s+2)%3;r=Math.sqrt(e[s*3+s]-e[a*3+a]-e[i*3+i]+1),t[s]=.5*r,r=.5/r,t[3]=(e[a*3+i]-e[i*3+a])*r,t[a]=(e[a*3+s]+e[s*3+a])*r,t[i]=(e[i*3+s]+e[s*3+i])*r}return t}function Gn(t,e,n,r){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:es,a=Math.PI/360;e*=a,r*=a,n*=a;var i=Math.sin(e),o=Math.cos(e),l=Math.sin(n),u=Math.cos(n),c=Math.sin(r),h=Math.cos(r);switch(s){case"xyz":t[0]=i*u*h+o*l*c,t[1]=o*l*h-i*u*c,t[2]=o*u*c+i*l*h,t[3]=o*u*h-i*l*c;break;case"xzy":t[0]=i*u*h-o*l*c,t[1]=o*l*h-i*u*c,t[2]=o*u*c+i*l*h,t[3]=o*u*h+i*l*c;break;case"yxz":t[0]=i*u*h+o*l*c,t[1]=o*l*h-i*u*c,t[2]=o*u*c-i*l*h,t[3]=o*u*h+i*l*c;break;case"yzx":t[0]=i*u*h+o*l*c,t[1]=o*l*h+i*u*c,t[2]=o*u*c-i*l*h,t[3]=o*u*h-i*l*c;break;case"zxy":t[0]=i*u*h-o*l*c,t[1]=o*l*h+i*u*c,t[2]=o*u*c+i*l*h,t[3]=o*u*h-i*l*c;break;case"zyx":t[0]=i*u*h-o*l*c,t[1]=o*l*h+i*u*c,t[2]=o*u*c-i*l*h,t[3]=o*u*h+i*l*c;break;default:throw new Error("Unknown angle order "+s)}return t}var bs=ps,zt=ms;(function(){var t=te(),e=ot(1,0,0),n=ot(0,1,0);return function(r,s,a){var i=us(s,a);return i<-.999999?(Vt(t,e,s),ds(t)<1e-6&&Vt(t,n,s),cs(t,t),ys(r,t,Math.PI),r):i>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Vt(t,s,a),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=1+i,zt(r,r))}})(),(function(){var t=Q(),e=Q();return function(n,r,s,a,i,o){return je(t,r,i,o),je(e,s,a,o),je(n,t,e,2*o*(1-o)),n}})(),(function(){var t=jt();return function(e,n,r,s){return t[0]=r[0],t[3]=r[1],t[6]=r[2],t[1]=s[0],t[4]=s[1],t[7]=s[2],t[2]=-n[0],t[5]=-n[1],t[8]=-n[2],zt(e,Un(e,t))}})();const T=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,B=Object.keys,V=Array.isArray;function H(t,e){return typeof e!="object"||B(e).forEach((function(n){t[n]=e[n]})),t}typeof Promise>"u"||T.Promise||(T.Promise=Promise);const Be=Object.getPrototypeOf,ws={}.hasOwnProperty;function G(t,e){return ws.call(t,e)}function Pe(t,e){typeof e=="function"&&(e=e(Be(t))),(typeof Reflect>"u"?B:Reflect.ownKeys)(e).forEach((n=>{ne(t,n,e[n])}))}const Wn=Object.defineProperty;function ne(t,e,n,r){Wn(t,e,H(n&&G(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function Ce(t){return{from:function(e){return t.prototype=Object.create(e.prototype),ne(t.prototype,"constructor",t),{extend:Pe.bind(null,t.prototype)}}}}const _s=Object.getOwnPropertyDescriptor;function Lt(t,e){let n;return _s(t,e)||(n=Be(t))&&Lt(n,e)}const xs=[].slice;function lt(t,e,n){return xs.call(t,e,n)}function Yn(t,e){return e(t)}function Ne(t){if(!t)throw new Error("Assertion Failed")}function Xn(t){T.setImmediate?setImmediate(t):setTimeout(t,0)}function Qn(t,e){return t.reduce(((n,r,s)=>{var a=e(r,s);return a&&(n[a[0]]=a[1]),n}),{})}function re(t,e){if(typeof e=="string"&&G(t,e))return t[e];if(!e)return t;if(typeof e!="string"){for(var n=[],r=0,s=e.length;r<s;++r){var a=re(t,e[r]);n.push(a)}return n}var i=e.indexOf(".");if(i!==-1){var o=t[e.substr(0,i)];return o==null?void 0:re(o,e.substr(i+1))}}function X(t,e,n){if(t&&e!==void 0&&(!("isFrozen"in Object)||!Object.isFrozen(t)))if(typeof e!="string"&&"length"in e){Ne(typeof n!="string"&&"length"in n);for(var r=0,s=e.length;r<s;++r)X(t,e[r],n[r])}else{var a=e.indexOf(".");if(a!==-1){var i=e.substr(0,a),o=e.substr(a+1);if(o==="")n===void 0?V(t)&&!isNaN(parseInt(i))?t.splice(i,1):delete t[i]:t[i]=n;else{var l=t[i];l&&G(t,i)||(l=t[i]={}),X(l,o,n)}}else n===void 0?V(t)&&!isNaN(parseInt(e))?t.splice(e,1):delete t[e]:t[e]=n}}function Jn(t){var e={};for(var n in t)G(t,n)&&(e[n]=t[n]);return e}const ks=[].concat;function Zn(t){return ks.apply([],t)}const er="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Zn([8,16,32,64].map((t=>["Int","Uint","Float"].map((e=>e+t+"Array")))))).filter((t=>T[t])),Es=er.map((t=>T[t]));Qn(er,(t=>[t,!0]));let ce=null;function $e(t){ce=typeof WeakMap<"u"&&new WeakMap;const e=Ht(t);return ce=null,e}function Ht(t){if(!t||typeof t!="object")return t;let e=ce&&ce.get(t);if(e)return e;if(V(t)){e=[],ce&&ce.set(t,e);for(var n=0,r=t.length;n<r;++n)e.push(Ht(t[n]))}else if(Es.indexOf(t.constructor)>=0)e=t;else{const a=Be(t);for(var s in e=a===Object.prototype?{}:Object.create(a),ce&&ce.set(t,e),t)G(t,s)&&(e[s]=Ht(t[s]))}return e}const{toString:Ms}={};function Ut(t){return Ms.call(t).slice(8,-1)}const Gt=typeof Symbol<"u"?Symbol.iterator:"@@iterator",As=typeof Gt=="symbol"?function(t){var e;return t!=null&&(e=t[Gt])&&e.apply(t)}:function(){return null},Oe={};function se(t){var e,n,r,s;if(arguments.length===1){if(V(t))return t.slice();if(this===Oe&&typeof t=="string")return[t];if(s=As(t)){for(n=[];!(r=s.next()).done;)n.push(r.value);return n}if(t==null)return[t];if(typeof(e=t.length)=="number"){for(n=new Array(e);e--;)n[e]=t[e];return n}return[t]}for(e=arguments.length,n=new Array(e);e--;)n[e]=arguments[e];return n}const Wt=typeof Symbol<"u"?t=>t[Symbol.toStringTag]==="AsyncFunction":()=>!1;var J=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function tr(t,e){J=t,nr=e}var nr=()=>!0;const Ps=!new Error("").stack;function ve(){if(Ps)try{throw ve.arguments,new Error}catch(t){return t}return new Error}function Yt(t,e){var n=t.stack;return n?(e=e||0,n.indexOf(t.name)===0&&(e+=(t.name+t.message).split(`
`).length),n.split(`
`).slice(e).filter(nr).map((r=>`
`+r)).join("")):""}var rr=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Xt=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(rr),Cs={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Se(t,e){this._e=ve(),this.name=t,this.message=e}function sr(t,e){return t+". Errors: "+Object.keys(e).map((n=>e[n].toString())).filter(((n,r,s)=>s.indexOf(n)===r)).join(`
`)}function ct(t,e,n,r){this._e=ve(),this.failures=e,this.failedKeys=r,this.successCount=n,this.message=sr(t,e)}function qe(t,e){this._e=ve(),this.name="BulkError",this.failures=Object.keys(e).map((n=>e[n])),this.failuresByPos=e,this.message=sr(t,e)}Ce(Se).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Yt(this._e,2))}},toString:function(){return this.name+": "+this.message}}),Ce(ct).from(Se),Ce(qe).from(Se);var Qt=Xt.reduce(((t,e)=>(t[e]=e+"Error",t)),{});const Os=Se;var P=Xt.reduce(((t,e)=>{var n=e+"Error";function r(s,a){this._e=ve(),this.name=n,s?typeof s=="string"?(this.message=`${s}${a?`
 `+a:""}`,this.inner=a||null):typeof s=="object"&&(this.message=`${s.name} ${s.message}`,this.inner=s):(this.message=Cs[e]||n,this.inner=null)}return Ce(r).from(Os),t[e]=r,t}),{});P.Syntax=SyntaxError,P.Type=TypeError,P.Range=RangeError;var ar=rr.reduce(((t,e)=>(t[e+"Error"]=P[e],t)),{}),ut=Xt.reduce(((t,e)=>(["Syntax","Type","Range"].indexOf(e)===-1&&(t[e+"Error"]=P[e]),t)),{});function I(){}function Ve(t){return t}function Ss(t,e){return t==null||t===Ve?e:function(n){return e(t(n))}}function be(t,e){return function(){t.apply(this,arguments),e.apply(this,arguments)}}function Rs(t,e){return t===I?e:function(){var n=t.apply(this,arguments);n!==void 0&&(arguments[0]=n);var r=this.onsuccess,s=this.onerror;this.onsuccess=null,this.onerror=null;var a=e.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?be(r,this.onsuccess):r),s&&(this.onerror=this.onerror?be(s,this.onerror):s),a!==void 0?a:n}}function Is(t,e){return t===I?e:function(){t.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,e.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?be(n,this.onsuccess):n),r&&(this.onerror=this.onerror?be(r,this.onerror):r)}}function Ts(t,e){return t===I?e:function(n){var r=t.apply(this,arguments);H(n,r);var s=this.onsuccess,a=this.onerror;this.onsuccess=null,this.onerror=null;var i=e.apply(this,arguments);return s&&(this.onsuccess=this.onsuccess?be(s,this.onsuccess):s),a&&(this.onerror=this.onerror?be(a,this.onerror):a),r===void 0?i===void 0?void 0:i:H(r,i)}}function Ds(t,e){return t===I?e:function(){return e.apply(this,arguments)!==!1&&t.apply(this,arguments)}}function Jt(t,e){return t===I?e:function(){var n=t.apply(this,arguments);if(n&&typeof n.then=="function"){for(var r=this,s=arguments.length,a=new Array(s);s--;)a[s]=arguments[s];return n.then((function(){return e.apply(r,a)}))}return e.apply(this,arguments)}}ut.ModifyError=ct,ut.DexieError=Se,ut.BulkError=qe;var ze={};const ir=100,[Zt,ht,en]=typeof Promise>"u"?[]:(()=>{let t=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[t,Be(t),t];const e=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[e,Be(e),t]})(),or=ht&&ht.then,dt=Zt&&Zt.constructor,tn=!!en;var nn=!1,Ks=en?()=>{en.then(yt)}:T.setImmediate?setImmediate.bind(null,yt):T.MutationObserver?()=>{var t=document.createElement("div");new MutationObserver((()=>{yt(),t=null})).observe(t,{attributes:!0}),t.setAttribute("i","1")}:()=>{setTimeout(yt,0)},Le=function(t,e){He.push([t,e]),ft&&(Ks(),ft=!1)},rn=!0,ft=!0,we=[],pt=[],sn=null,an=Ve,Re={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:gr,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach((t=>{try{gr(t[0],t[1])}catch{}}))}},A=Re,He=[],_e=0,mt=[];function M(t){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=I,this._lib=!1;var e=this._PSD=A;if(J&&(this._stackHolder=ve(),this._prev=null,this._numPrev=0),typeof t!="function"){if(t!==ze)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&ln(this,this._value))}this._state=null,this._value=null,++e.ref,cr(this,t)}const on={get:function(){var t=A,e=bt;function n(r,s){var a=!t.global&&(t!==A||e!==bt);const i=a&&!ae();var o=new M(((l,u)=>{cn(this,new lr(_t(r,t,a,i),_t(s,t,a,i),l,u,t))}));return J&&dr(o,this),o}return n.prototype=ze,n},set:function(t){ne(this,"then",t&&t.prototype===ze?on:{get:function(){return t},set:on.set})}};function lr(t,e,n,r,s){this.onFulfilled=typeof t=="function"?t:null,this.onRejected=typeof e=="function"?e:null,this.resolve=n,this.reject=r,this.psd=s}function cr(t,e){try{e((n=>{if(t._state===null){if(n===t)throw new TypeError("A promise cannot be resolved with itself.");var r=t._lib&&Ue();n&&typeof n.then=="function"?cr(t,((s,a)=>{n instanceof M?n._then(s,a):n.then(s,a)})):(t._state=!0,t._value=n,ur(t)),r&&Ge()}}),ln.bind(null,t))}catch(n){ln(t,n)}}function ln(t,e){if(pt.push(e),t._state===null){var n=t._lib&&Ue();e=an(e),t._state=!1,t._value=e,J&&e!==null&&typeof e=="object"&&!e._promise&&(function(r,s,a){try{r.apply(null,a)}catch{}})((()=>{var r=Lt(e,"stack");e._promise=t,ne(e,"stack",{get:()=>nn?r&&(r.get?r.get.apply(e):r.value):t.stack})})),(function(r){we.some((s=>s._value===r._value))||we.push(r)})(t),ur(t),n&&Ge()}}function ur(t){var e=t._listeners;t._listeners=[];for(var n=0,r=e.length;n<r;++n)cn(t,e[n]);var s=t._PSD;--s.ref||s.finalize(),_e===0&&(++_e,Le((()=>{--_e==0&&un()}),[]))}function cn(t,e){if(t._state!==null){var n=t._state?e.onFulfilled:e.onRejected;if(n===null)return(t._state?e.resolve:e.reject)(t._value);++e.psd.ref,++_e,Le(Fs,[n,t,e])}else t._listeners.push(e)}function Fs(t,e,n){try{sn=e;var r,s=e._value;e._state?r=t(s):(pt.length&&(pt=[]),r=t(s),pt.indexOf(s)===-1&&(function(a){for(var i=we.length;i;)if(we[--i]._value===a._value)return void we.splice(i,1)})(e)),n.resolve(r)}catch(a){n.reject(a)}finally{sn=null,--_e==0&&un(),--n.psd.ref||n.psd.finalize()}}function hr(t,e,n){if(e.length===n)return e;var r="";if(t._state===!1){var s,a,i=t._value;i!=null?(s=i.name||"Error",a=i.message||i,r=Yt(i,0)):(s=i,a=""),e.push(s+(a?": "+a:"")+r)}return J&&((r=Yt(t._stackHolder,2))&&e.indexOf(r)===-1&&e.push(r),t._prev&&hr(t._prev,e,n)),e}function dr(t,e){var n=e?e._numPrev+1:0;n<100&&(t._prev=e,t._numPrev=n)}function yt(){Ue()&&Ge()}function Ue(){var t=rn;return rn=!1,ft=!1,t}function Ge(){var t,e,n;do for(;He.length>0;)for(t=He,He=[],n=t.length,e=0;e<n;++e){var r=t[e];r[0].apply(null,r[1])}while(He.length>0);rn=!0,ft=!0}function un(){var t=we;we=[],t.forEach((r=>{r._PSD.onunhandled.call(null,r._value,r)}));for(var e=mt.slice(0),n=e.length;n;)e[--n]()}function gt(t){return new M(ze,!1,t)}function K(t,e){var n=A;return function(){var r=Ue(),s=A;try{return he(n,!0),t.apply(this,arguments)}catch(a){e&&e(a)}finally{he(s,!1),r&&Ge()}}}Pe(M.prototype,{then:on,_then:function(t,e){cn(this,new lr(null,null,t,e,A))},catch:function(t){if(arguments.length===1)return this.then(null,t);var e=arguments[0],n=arguments[1];return typeof e=="function"?this.then(null,(r=>r instanceof e?n(r):gt(r))):this.then(null,(r=>r&&r.name===e?n(r):gt(r)))},finally:function(t){return this.then((e=>(t(),e)),(e=>(t(),gt(e))))},stack:{get:function(){if(this._stack)return this._stack;try{nn=!0;var t=hr(this,[],20).join(`
From previous: `);return this._state!==null&&(this._stack=t),t}finally{nn=!1}}},timeout:function(t,e){return t<1/0?new M(((n,r)=>{var s=setTimeout((()=>r(new P.Timeout(e))),t);this.then(n,r).finally(clearTimeout.bind(null,s))})):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&ne(M.prototype,Symbol.toStringTag,"Dexie.Promise"),Re.env=fr(),Pe(M,{all:function(){var t=se.apply(null,arguments).map(wt);return new M((function(e,n){t.length===0&&e([]);var r=t.length;t.forEach(((s,a)=>M.resolve(s).then((i=>{t[a]=i,--r||e(t)}),n)))}))},resolve:t=>{if(t instanceof M)return t;if(t&&typeof t.then=="function")return new M(((n,r)=>{t.then(n,r)}));var e=new M(ze,!0,t);return dr(e,sn),e},reject:gt,race:function(){var t=se.apply(null,arguments).map(wt);return new M(((e,n)=>{t.map((r=>M.resolve(r).then(e,n)))}))},PSD:{get:()=>A,set:t=>A=t},totalEchoes:{get:()=>bt},newPSD:ue,usePSD:Te,scheduler:{get:()=>Le,set:t=>{Le=t}},rejectionMapper:{get:()=>an,set:t=>{an=t}},follow:(t,e)=>new M(((n,r)=>ue(((s,a)=>{var i=A;i.unhandleds=[],i.onunhandled=a,i.finalize=be((function(){(function(o){function l(){o(),mt.splice(mt.indexOf(l),1)}mt.push(l),++_e,Le((()=>{--_e==0&&un()}),[])})((()=>{this.unhandleds.length===0?s():a(this.unhandleds[0])}))}),i.finalize),t()}),e,n,r)))}),dt&&(dt.allSettled&&ne(M,"allSettled",(function(){const t=se.apply(null,arguments).map(wt);return new M((e=>{t.length===0&&e([]);let n=t.length;const r=new Array(n);t.forEach(((s,a)=>M.resolve(s).then((i=>r[a]={status:"fulfilled",value:i}),(i=>r[a]={status:"rejected",reason:i})).then((()=>--n||e(r)))))}))})),dt.any&&typeof AggregateError<"u"&&ne(M,"any",(function(){const t=se.apply(null,arguments).map(wt);return new M(((e,n)=>{t.length===0&&n(new AggregateError([]));let r=t.length;const s=new Array(r);t.forEach(((a,i)=>M.resolve(a).then((o=>e(o)),(o=>{s[i]=o,--r||n(new AggregateError(s))}))))}))})));const z={awaits:0,echoes:0,id:0};var js=0,vt=[],hn=0,bt=0,Bs=0;function ue(t,e,n,r){var s=A,a=Object.create(s);a.parent=s,a.ref=0,a.global=!1,a.id=++Bs;var i=Re.env;a.env=tn?{Promise:M,PromiseProp:{value:M,configurable:!0,writable:!0},all:M.all,race:M.race,allSettled:M.allSettled,any:M.any,resolve:M.resolve,reject:M.reject,nthen:mr(i.nthen,a),gthen:mr(i.gthen,a)}:{},e&&H(a,e),++s.ref,a.finalize=function(){--this.parent.ref||this.parent.finalize()};var o=Te(a,t,n,r);return a.ref===0&&a.finalize(),o}function Ie(){return z.id||(z.id=++js),++z.awaits,z.echoes+=ir,z.id}function ae(){return!!z.awaits&&(--z.awaits==0&&(z.id=0),z.echoes=z.awaits*ir,!0)}function wt(t){return z.echoes&&t&&t.constructor===dt?(Ie(),t.then((e=>(ae(),e)),(e=>(ae(),N(e))))):t}function Ns(t){++bt,z.echoes&&--z.echoes!=0||(z.echoes=z.id=0),vt.push(A),he(t,!0)}function $s(){var t=vt[vt.length-1];vt.pop(),he(t,!1)}function he(t,e){var n=A;if((e?!z.echoes||hn++&&t===A:!hn||--hn&&t===A)||pr(e?Ns.bind(null,t):$s),t!==A&&(A=t,n===Re&&(Re.env=fr()),tn)){var r=Re.env.Promise,s=t.env;ht.then=s.nthen,r.prototype.then=s.gthen,(n.global||t.global)&&(Object.defineProperty(T,"Promise",s.PromiseProp),r.all=s.all,r.race=s.race,r.resolve=s.resolve,r.reject=s.reject,s.allSettled&&(r.allSettled=s.allSettled),s.any&&(r.any=s.any))}}function fr(){var t=T.Promise;return tn?{Promise:t,PromiseProp:Object.getOwnPropertyDescriptor(T,"Promise"),all:t.all,race:t.race,allSettled:t.allSettled,any:t.any,resolve:t.resolve,reject:t.reject,nthen:ht.then,gthen:t.prototype.then}:{}}function Te(t,e,n,r,s){var a=A;try{return he(t,!0),e(n,r,s)}finally{he(a,!1)}}function pr(t){or.call(Zt,t)}function _t(t,e,n,r){return typeof t!="function"?t:function(){var s=A;n&&Ie(),he(e,!0);try{return t.apply(this,arguments)}finally{he(s,!1),r&&pr(ae)}}}function mr(t,e){return function(n,r){return t.call(this,_t(n,e),_t(r,e))}}(""+or).indexOf("[native code]")===-1&&(Ie=ae=I);const yr="unhandledrejection";function gr(t,e){var n;try{n=e.onuncatched(t)}catch{}if(n!==!1)try{var r,s={promise:e,reason:t};if(T.document&&document.createEvent?((r=document.createEvent("Event")).initEvent(yr,!0,!0),H(r,s)):T.CustomEvent&&H(r=new CustomEvent(yr,{detail:s}),s),r&&T.dispatchEvent&&(dispatchEvent(r),!T.PromiseRejectionEvent&&T.onunhandledrejection))try{T.onunhandledrejection(r)}catch{}J&&r&&!r.defaultPrevented&&console.warn(`Unhandled rejection: ${t.stack||t}`)}catch{}}var N=M.reject;function dn(t,e,n,r){if(t.idbdb&&(t._state.openComplete||A.letThrough||t._vip)){var s=t._createTransaction(e,n,t._dbSchema);try{s.create(),t._state.PR1398_maxLoop=3}catch(a){return a.name===Qt.InvalidState&&t.isOpen()&&--t._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),t._close(),t.open().then((()=>dn(t,e,n,r)))):N(a)}return s._promise(e,((a,i)=>ue((()=>(A.trans=s,r(a,i,s)))))).then((a=>s._completion.then((()=>a))))}if(t._state.openComplete)return N(new P.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._options.autoOpen)return N(new P.DatabaseClosed);t.open().catch(I)}return t._state.dbReadyPromise.then((()=>dn(t,e,n,r)))}const vr="3.2.7",xe="ï¿¿",fn=-1/0,ie="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",br="String expected.",We=[],xt=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),qs=xt,Vs=xt,wr=t=>!/(dexie\.js|dexie\.min\.js)/.test(t),kt="__dbnames",pn="readonly",mn="readwrite";function ke(t,e){return t?e?function(){return t.apply(this,arguments)&&e.apply(this,arguments)}:t:e}const _r={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Et(t){return typeof t!="string"||/\./.test(t)?e=>e:e=>(e[t]===void 0&&t in e&&delete(e=$e(e))[t],e)}class zs{_trans(e,n,r){const s=this._tx||A.trans,a=this.name;function i(l,u,c){if(!c.schema[a])throw new P.NotFound("Table "+a+" not part of transaction");return n(c.idbtrans,c)}const o=Ue();try{return s&&s.db===this.db?s===A.trans?s._promise(e,i,r):ue((()=>s._promise(e,i,r)),{trans:s,transless:A.transless||A}):dn(this.db,e,[this.name],i)}finally{o&&Ge()}}get(e,n){return e&&e.constructor===Object?this.where(e).first(n):this._trans("readonly",(r=>this.core.get({trans:r,key:e}).then((s=>this.hook.reading.fire(s))))).then(n)}where(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(V(e))return new this.db.WhereClause(this,`[${e.join("+")}]`);const n=B(e);if(n.length===1)return this.where(n[0]).equals(e[n[0]]);const r=this.schema.indexes.concat(this.schema.primKey).filter((u=>{if(u.compound&&n.every((c=>u.keyPath.indexOf(c)>=0))){for(let c=0;c<n.length;++c)if(n.indexOf(u.keyPath[c])===-1)return!1;return!0}return!1})).sort(((u,c)=>u.keyPath.length-c.keyPath.length))[0];if(r&&this.db._maxKey!==xe){const u=r.keyPath.slice(0,n.length);return this.where(u).equals(u.map((c=>e[c])))}!r&&J&&console.warn(`The query ${JSON.stringify(e)} on ${this.name} would benefit of a compound index [${n.join("+")}]`);const{idxByName:s}=this.schema,a=this.db._deps.indexedDB;function i(u,c){try{return a.cmp(u,c)===0}catch{return!1}}const[o,l]=n.reduce((([u,c],h)=>{const d=s[h],f=e[h];return[u||d,u||!d?ke(c,d&&d.multi?v=>{const y=re(v,h);return V(y)&&y.some((m=>i(f,m)))}:v=>i(f,re(v,h))):c]}),[null,null]);return o?this.where(o.name).equals(e[o.keyPath]).filter(l):r?this.filter(l):this.where(n).equals("")}filter(e){return this.toCollection().and(e)}count(e){return this.toCollection().count(e)}offset(e){return this.toCollection().offset(e)}limit(e){return this.toCollection().limit(e)}each(e){return this.toCollection().each(e)}toArray(e){return this.toCollection().toArray(e)}toCollection(){return new this.db.Collection(new this.db.WhereClause(this))}orderBy(e){return new this.db.Collection(new this.db.WhereClause(this,V(e)?`[${e.join("+")}]`:e))}reverse(){return this.toCollection().reverse()}mapToClass(e){this.schema.mappedClass=e;const n=r=>{if(!r)return r;const s=Object.create(e.prototype);for(var a in r)if(G(r,a))try{s[a]=r[a]}catch{}return s};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=n,this.hook("reading",n),e}defineClass(){return this.mapToClass((function(e){H(this,e)}))}add(e,n){const{auto:r,keyPath:s}=this.schema.primKey;let a=e;return s&&r&&(a=Et(s)(e)),this._trans("readwrite",(i=>this.core.mutate({trans:i,type:"add",keys:n!=null?[n]:null,values:[a]}))).then((i=>i.numFailures?M.reject(i.failures[0]):i.lastResult)).then((i=>{if(s)try{X(e,s,i)}catch{}return i}))}update(e,n){if(typeof e!="object"||V(e))return this.where(":id").equals(e).modify(n);{const r=re(e,this.schema.primKey.keyPath);if(r===void 0)return N(new P.InvalidArgument("Given object does not contain its primary key"));try{typeof n!="function"?B(n).forEach((s=>{X(e,s,n[s])})):n(e,{value:e,primKey:r})}catch{}return this.where(":id").equals(r).modify(n)}}put(e,n){const{auto:r,keyPath:s}=this.schema.primKey;let a=e;return s&&r&&(a=Et(s)(e)),this._trans("readwrite",(i=>this.core.mutate({trans:i,type:"put",values:[a],keys:n!=null?[n]:null}))).then((i=>i.numFailures?M.reject(i.failures[0]):i.lastResult)).then((i=>{if(s)try{X(e,s,i)}catch{}return i}))}delete(e){return this._trans("readwrite",(n=>this.core.mutate({trans:n,type:"delete",keys:[e]}))).then((n=>n.numFailures?M.reject(n.failures[0]):void 0))}clear(){return this._trans("readwrite",(e=>this.core.mutate({trans:e,type:"deleteRange",range:_r}))).then((e=>e.numFailures?M.reject(e.failures[0]):void 0))}bulkGet(e){return this._trans("readonly",(n=>this.core.getMany({keys:e,trans:n}).then((r=>r.map((s=>this.hook.reading.fire(s)))))))}bulkAdd(e,n,r){const s=Array.isArray(n)?n:void 0,a=(r=r||(s?void 0:n))?r.allKeys:void 0;return this._trans("readwrite",(i=>{const{auto:o,keyPath:l}=this.schema.primKey;if(l&&s)throw new P.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(s&&s.length!==e.length)throw new P.InvalidArgument("Arguments objects and keys must have the same length");const u=e.length;let c=l&&o?e.map(Et(l)):e;return this.core.mutate({trans:i,type:"add",keys:s,values:c,wantResults:a}).then((({numFailures:h,results:d,lastResult:f,failures:v})=>{if(h===0)return a?d:f;throw new qe(`${this.name}.bulkAdd(): ${h} of ${u} operations failed`,v)}))}))}bulkPut(e,n,r){const s=Array.isArray(n)?n:void 0,a=(r=r||(s?void 0:n))?r.allKeys:void 0;return this._trans("readwrite",(i=>{const{auto:o,keyPath:l}=this.schema.primKey;if(l&&s)throw new P.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(s&&s.length!==e.length)throw new P.InvalidArgument("Arguments objects and keys must have the same length");const u=e.length;let c=l&&o?e.map(Et(l)):e;return this.core.mutate({trans:i,type:"put",keys:s,values:c,wantResults:a}).then((({numFailures:h,results:d,lastResult:f,failures:v})=>{if(h===0)return a?d:f;throw new qe(`${this.name}.bulkPut(): ${h} of ${u} operations failed`,v)}))}))}bulkDelete(e){const n=e.length;return this._trans("readwrite",(r=>this.core.mutate({trans:r,type:"delete",keys:e}))).then((({numFailures:r,lastResult:s,failures:a})=>{if(r===0)return s;throw new qe(`${this.name}.bulkDelete(): ${r} of ${n} operations failed`,a)}))}}function Ye(t){var e={},n=function(i,o){if(o){for(var l=arguments.length,u=new Array(l-1);--l;)u[l-1]=arguments[l];return e[i].subscribe.apply(null,u),t}if(typeof i=="string")return e[i]};n.addEventType=a;for(var r=1,s=arguments.length;r<s;++r)a(arguments[r]);return n;function a(i,o,l){if(typeof i!="object"){var u;o||(o=Ds),l||(l=I);var c={subscribers:[],fire:l,subscribe:function(h){c.subscribers.indexOf(h)===-1&&(c.subscribers.push(h),c.fire=o(c.fire,h))},unsubscribe:function(h){c.subscribers=c.subscribers.filter((function(d){return d!==h})),c.fire=c.subscribers.reduce(o,l)}};return e[i]=n[i]=c,c}B(u=i).forEach((function(h){var d=u[h];if(V(d))a(h,u[h][0],u[h][1]);else{if(d!=="asap")throw new P.InvalidArgument("Invalid event config");var f=a(h,Ve,(function(){for(var v=arguments.length,y=new Array(v);v--;)y[v]=arguments[v];f.subscribers.forEach((function(m){Xn((function(){m.apply(null,y)}))}))}))}}))}}function Xe(t,e){return Ce(e).from({prototype:t}),e}function De(t,e){return!(t.filter||t.algorithm||t.or)&&(e?t.justLimit:!t.replayFilter)}function yn(t,e){t.filter=ke(t.filter,e)}function gn(t,e,n){var r=t.replayFilter;t.replayFilter=r?()=>ke(r(),e()):e,t.justLimit=n&&!r}function Mt(t,e){if(t.isPrimKey)return e.primaryKey;const n=e.getIndexByKeyPath(t.index);if(!n)throw new P.Schema("KeyPath "+t.index+" on object store "+e.name+" is not indexed");return n}function xr(t,e,n){const r=Mt(t,e.schema);return e.openCursor({trans:n,values:!t.keysOnly,reverse:t.dir==="prev",unique:!!t.unique,query:{index:r,range:t.range}})}function At(t,e,n,r){const s=t.replayFilter?ke(t.filter,t.replayFilter()):t.filter;if(t.or){const a={},i=(o,l,u)=>{if(!s||s(l,u,(d=>l.stop(d)),(d=>l.fail(d)))){var c=l.primaryKey,h=""+c;h==="[object ArrayBuffer]"&&(h=""+new Uint8Array(c)),G(a,h)||(a[h]=!0,e(o,l,u))}};return Promise.all([t.or._iterate(i,n),kr(xr(t,r,n),t.algorithm,i,!t.keysOnly&&t.valueMapper)])}return kr(xr(t,r,n),ke(t.algorithm,s),e,!t.keysOnly&&t.valueMapper)}function kr(t,e,n,r){var s=K(r?(a,i,o)=>n(r(a),i,o):n);return t.then((a=>{if(a)return a.start((()=>{var i=()=>a.continue();e&&!e(a,(o=>i=o),(o=>{a.stop(o),i=I}),(o=>{a.fail(o),i=I}))||s(a.value,a,(o=>i=o)),i()}))}))}function U(t,e){try{const n=Er(t),r=Er(e);if(n!==r)return n==="Array"?1:r==="Array"?-1:n==="binary"?1:r==="binary"?-1:n==="string"?1:r==="string"?-1:n==="Date"?1:r!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return t>e?1:t<e?-1:0;case"binary":return(function(s,a){const i=s.length,o=a.length,l=i<o?i:o;for(let u=0;u<l;++u)if(s[u]!==a[u])return s[u]<a[u]?-1:1;return i===o?0:i<o?-1:1})(Mr(t),Mr(e));case"Array":return(function(s,a){const i=s.length,o=a.length,l=i<o?i:o;for(let u=0;u<l;++u){const c=U(s[u],a[u]);if(c!==0)return c}return i===o?0:i<o?-1:1})(t,e)}}catch{}return NaN}function Er(t){const e=typeof t;if(e!=="object")return e;if(ArrayBuffer.isView(t))return"binary";const n=Ut(t);return n==="ArrayBuffer"?"binary":n}function Mr(t){return t instanceof Uint8Array?t:ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t)}class Ls{_read(e,n){var r=this._ctx;return r.error?r.table._trans(null,N.bind(null,r.error)):r.table._trans("readonly",e).then(n)}_write(e){var n=this._ctx;return n.error?n.table._trans(null,N.bind(null,n.error)):n.table._trans("readwrite",e,"locked")}_addAlgorithm(e){var n=this._ctx;n.algorithm=ke(n.algorithm,e)}_iterate(e,n){return At(this._ctx,e,n,this._ctx.table.core)}clone(e){var n=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return e&&H(r,e),n._ctx=r,n}raw(){return this._ctx.valueMapper=null,this}each(e){var n=this._ctx;return this._read((r=>At(n,e,r,n.table.core)))}count(e){return this._read((n=>{const r=this._ctx,s=r.table.core;if(De(r,!0))return s.count({trans:n,query:{index:Mt(r,s.schema),range:r.range}}).then((i=>Math.min(i,r.limit)));var a=0;return At(r,(()=>(++a,!1)),n,s).then((()=>a))})).then(e)}sortBy(e,n){const r=e.split(".").reverse(),s=r[0],a=r.length-1;function i(u,c){return c?i(u[r[c]],c-1):u[s]}var o=this._ctx.dir==="next"?1:-1;function l(u,c){var h=i(u,a),d=i(c,a);return h<d?-o:h>d?o:0}return this.toArray((function(u){return u.sort(l)})).then(n)}toArray(e){return this._read((n=>{var r=this._ctx;if(r.dir==="next"&&De(r,!0)&&r.limit>0){const{valueMapper:s}=r,a=Mt(r,r.table.core.schema);return r.table.core.query({trans:n,limit:r.limit,values:!0,query:{index:a,range:r.range}}).then((({result:i})=>s?i.map(s):i))}{const s=[];return At(r,(a=>s.push(a)),n,r.table.core).then((()=>s))}}),e)}offset(e){var n=this._ctx;return e<=0||(n.offset+=e,De(n)?gn(n,(()=>{var r=e;return(s,a)=>r===0||(r===1?(--r,!1):(a((()=>{s.advance(r),r=0})),!1))})):gn(n,(()=>{var r=e;return()=>--r<0}))),this}limit(e){return this._ctx.limit=Math.min(this._ctx.limit,e),gn(this._ctx,(()=>{var n=e;return function(r,s,a){return--n<=0&&s(a),n>=0}}),!0),this}until(e,n){return yn(this._ctx,(function(r,s,a){return!e(r.value)||(s(a),n)})),this}first(e){return this.limit(1).toArray((function(n){return n[0]})).then(e)}last(e){return this.reverse().first(e)}filter(e){var n,r;return yn(this._ctx,(function(s){return e(s.value)})),n=this._ctx,r=e,n.isMatch=ke(n.isMatch,r),this}and(e){return this.filter(e)}or(e){return new this.db.WhereClause(this._ctx.table,e,this)}reverse(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this}desc(){return this.reverse()}eachKey(e){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each((function(r,s){e(s.key,s)}))}eachUniqueKey(e){return this._ctx.unique="unique",this.eachKey(e)}eachPrimaryKey(e){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each((function(r,s){e(s.primaryKey,s)}))}keys(e){var n=this._ctx;n.keysOnly=!n.isMatch;var r=[];return this.each((function(s,a){r.push(a.key)})).then((function(){return r})).then(e)}primaryKeys(e){var n=this._ctx;if(n.dir==="next"&&De(n,!0)&&n.limit>0)return this._read((s=>{var a=Mt(n,n.table.core.schema);return n.table.core.query({trans:s,values:!1,limit:n.limit,query:{index:a,range:n.range}})})).then((({result:s})=>s)).then(e);n.keysOnly=!n.isMatch;var r=[];return this.each((function(s,a){r.push(a.primaryKey)})).then((function(){return r})).then(e)}uniqueKeys(e){return this._ctx.unique="unique",this.keys(e)}firstKey(e){return this.limit(1).keys((function(n){return n[0]})).then(e)}lastKey(e){return this.reverse().firstKey(e)}distinct(){var e=this._ctx,n=e.index&&e.table.schema.idxByName[e.index];if(!n||!n.multi)return this;var r={};return yn(this._ctx,(function(s){var a=s.primaryKey.toString(),i=G(r,a);return r[a]=!0,!i})),this}modify(e){var n=this._ctx;return this._write((r=>{var s;if(typeof e=="function")s=e;else{var a=B(e),i=a.length;s=function(y){for(var m=!1,g=0;g<i;++g){var p=a[g],w=e[p];re(y,p)!==w&&(X(y,p,w),m=!0)}return m}}const o=n.table.core,{outbound:l,extractKey:u}=o.schema.primaryKey,c=this.db._options.modifyChunkSize||200,h=[];let d=0;const f=[],v=(y,m)=>{const{failures:g,numFailures:p}=m;d+=y-p;for(let w of B(g))h.push(g[w])};return this.clone().primaryKeys().then((y=>{const m=g=>{const p=Math.min(c,y.length-g);return o.getMany({trans:r,keys:y.slice(g,g+p),cache:"immutable"}).then((w=>{const _=[],k=[],E=l?[]:null,b=[];for(let x=0;x<p;++x){const S=w[x],O={value:$e(S),primKey:y[g+x]};s.call(O,O.value,O)!==!1&&(O.value==null?b.push(y[g+x]):l||U(u(S),u(O.value))===0?(k.push(O.value),l&&E.push(y[g+x])):(b.push(y[g+x]),_.push(O.value)))}const C=De(n)&&n.limit===1/0&&(typeof e!="function"||e===vn)&&{index:n.index,range:n.range};return Promise.resolve(_.length>0&&o.mutate({trans:r,type:"add",values:_}).then((x=>{for(let S in x.failures)b.splice(parseInt(S),1);v(_.length,x)}))).then((()=>(k.length>0||C&&typeof e=="object")&&o.mutate({trans:r,type:"put",keys:E,values:k,criteria:C,changeSpec:typeof e!="function"&&e}).then((x=>v(k.length,x))))).then((()=>(b.length>0||C&&e===vn)&&o.mutate({trans:r,type:"delete",keys:b,criteria:C}).then((x=>v(b.length,x))))).then((()=>y.length>g+p&&m(g+c)))}))};return m(0).then((()=>{if(h.length>0)throw new ct("Error modifying one or more objects",h,d,f);return y.length}))}))}))}delete(){var e=this._ctx,n=e.range;return De(e)&&(e.isPrimKey&&!Vs||n.type===3)?this._write((r=>{const{primaryKey:s}=e.table.core.schema,a=n;return e.table.core.count({trans:r,query:{index:s,range:a}}).then((i=>e.table.core.mutate({trans:r,type:"deleteRange",range:a}).then((({failures:o,lastResult:l,results:u,numFailures:c})=>{if(c)throw new ct("Could not delete some values",Object.keys(o).map((h=>o[h])),i-c);return i-c}))))})):this.modify(vn)}}const vn=(t,e)=>e.value=null;function Hs(t,e){return t<e?-1:t===e?0:1}function Us(t,e){return t>e?-1:t===e?0:1}function W(t,e,n){var r=t instanceof Pr?new t.Collection(t):t;return r._ctx.error=n?new n(e):new TypeError(e),r}function Ke(t){return new t.Collection(t,(()=>Ar(""))).limit(0)}function Gs(t,e,n,r,s,a){for(var i=Math.min(t.length,r.length),o=-1,l=0;l<i;++l){var u=e[l];if(u!==r[l])return s(t[l],n[l])<0?t.substr(0,l)+n[l]+n.substr(l+1):s(t[l],r[l])<0?t.substr(0,l)+r[l]+n.substr(l+1):o>=0?t.substr(0,o)+e[o]+n.substr(o+1):null;s(t[l],u)<0&&(o=l)}return i<r.length&&a==="next"?t+n.substr(t.length):i<t.length&&a==="prev"?t.substr(0,n.length):o<0?null:t.substr(0,o)+r[o]+n.substr(o+1)}function Pt(t,e,n,r){var s,a,i,o,l,u,c,h=n.length;if(!n.every((y=>typeof y=="string")))return W(t,br);function d(y){s=(function(g){return g==="next"?p=>p.toUpperCase():p=>p.toLowerCase()})(y),a=(function(g){return g==="next"?p=>p.toLowerCase():p=>p.toUpperCase()})(y),i=y==="next"?Hs:Us;var m=n.map((function(g){return{lower:a(g),upper:s(g)}})).sort((function(g,p){return i(g.lower,p.lower)}));o=m.map((function(g){return g.upper})),l=m.map((function(g){return g.lower})),u=y,c=y==="next"?"":r}d("next");var f=new t.Collection(t,(()=>de(o[0],l[h-1]+r)));f._ondirectionchange=function(y){d(y)};var v=0;return f._addAlgorithm((function(y,m,g){var p=y.key;if(typeof p!="string")return!1;var w=a(p);if(e(w,l,v))return!0;for(var _=null,k=v;k<h;++k){var E=Gs(p,w,o[k],l[k],i,u);E===null&&_===null?v=k+1:(_===null||i(_,E)>0)&&(_=E)}return m(_!==null?function(){y.continue(_+c)}:g),!1})),f}function de(t,e,n,r){return{type:2,lower:t,upper:e,lowerOpen:n,upperOpen:r}}function Ar(t){return{type:1,lower:t,upper:t}}class Pr{get Collection(){return this._ctx.table.db.Collection}between(e,n,r,s){r=r!==!1,s=s===!0;try{return this._cmp(e,n)>0||this._cmp(e,n)===0&&(r||s)&&(!r||!s)?Ke(this):new this.Collection(this,(()=>de(e,n,!r,!s)))}catch{return W(this,ie)}}equals(e){return e==null?W(this,ie):new this.Collection(this,(()=>Ar(e)))}above(e){return e==null?W(this,ie):new this.Collection(this,(()=>de(e,void 0,!0)))}aboveOrEqual(e){return e==null?W(this,ie):new this.Collection(this,(()=>de(e,void 0,!1)))}below(e){return e==null?W(this,ie):new this.Collection(this,(()=>de(void 0,e,!1,!0)))}belowOrEqual(e){return e==null?W(this,ie):new this.Collection(this,(()=>de(void 0,e)))}startsWith(e){return typeof e!="string"?W(this,br):this.between(e,e+xe,!0,!0)}startsWithIgnoreCase(e){return e===""?this.startsWith(e):Pt(this,((n,r)=>n.indexOf(r[0])===0),[e],xe)}equalsIgnoreCase(e){return Pt(this,((n,r)=>n===r[0]),[e],"")}anyOfIgnoreCase(){var e=se.apply(Oe,arguments);return e.length===0?Ke(this):Pt(this,((n,r)=>r.indexOf(n)!==-1),e,"")}startsWithAnyOfIgnoreCase(){var e=se.apply(Oe,arguments);return e.length===0?Ke(this):Pt(this,((n,r)=>r.some((s=>n.indexOf(s)===0))),e,xe)}anyOf(){const e=se.apply(Oe,arguments);let n=this._cmp;try{e.sort(n)}catch{return W(this,ie)}if(e.length===0)return Ke(this);const r=new this.Collection(this,(()=>de(e[0],e[e.length-1])));r._ondirectionchange=a=>{n=a==="next"?this._ascending:this._descending,e.sort(n)};let s=0;return r._addAlgorithm(((a,i,o)=>{const l=a.key;for(;n(l,e[s])>0;)if(++s,s===e.length)return i(o),!1;return n(l,e[s])===0||(i((()=>{a.continue(e[s])})),!1)})),r}notEqual(e){return this.inAnyRange([[fn,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const e=se.apply(Oe,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return W(this,ie)}const n=e.reduce(((r,s)=>r?r.concat([[r[r.length-1][1],s]]):[[fn,s]]),null);return n.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(n,{includeLowers:!1,includeUppers:!1})}inAnyRange(e,n){const r=this._cmp,s=this._ascending,a=this._descending,i=this._min,o=this._max;if(e.length===0)return Ke(this);if(!e.every((p=>p[0]!==void 0&&p[1]!==void 0&&s(p[0],p[1])<=0)))return W(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",P.InvalidArgument);const l=!n||n.includeLowers!==!1,u=n&&n.includeUppers===!0;let c,h=s;function d(p,w){return h(p[0],w[0])}try{c=e.reduce((function(p,w){let _=0,k=p.length;for(;_<k;++_){const E=p[_];if(r(w[0],E[1])<0&&r(w[1],E[0])>0){E[0]=i(E[0],w[0]),E[1]=o(E[1],w[1]);break}}return _===k&&p.push(w),p}),[]),c.sort(d)}catch{return W(this,ie)}let f=0;const v=u?p=>s(p,c[f][1])>0:p=>s(p,c[f][1])>=0,y=l?p=>a(p,c[f][0])>0:p=>a(p,c[f][0])>=0;let m=v;const g=new this.Collection(this,(()=>de(c[0][0],c[c.length-1][1],!l,!u)));return g._ondirectionchange=p=>{p==="next"?(m=v,h=s):(m=y,h=a),c.sort(d)},g._addAlgorithm(((p,w,_)=>{for(var k=p.key;m(k);)if(++f,f===c.length)return w(_),!1;return!!(function(E){return!v(E)&&!y(E)})(k)||(this._cmp(k,c[f][1])===0||this._cmp(k,c[f][0])===0||w((()=>{h===s?p.continue(c[f][0]):p.continue(c[f][1])})),!1)})),g}startsWithAnyOf(){const e=se.apply(Oe,arguments);return e.every((n=>typeof n=="string"))?e.length===0?Ke(this):this.inAnyRange(e.map((n=>[n,n+xe]))):W(this,"startsWithAnyOf() only works with strings")}}function Z(t){return K((function(e){return Qe(e),t(e.target.error),!1}))}function Qe(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()}const Je="storagemutated",fe="x-storagemutated-1",pe=Ye(null,Je);class Ws{_lock(){return Ne(!A.global),++this._reculock,this._reculock!==1||A.global||(A.lockOwnerFor=this),this}_unlock(){if(Ne(!A.global),--this._reculock==0)for(A.global||(A.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{Te(e[1],e[0])}catch{}}return this}_locked(){return this._reculock&&A.lockOwnerFor!==this}create(e){if(!this.mode)return this;const n=this.db.idbdb,r=this.db._state.dbOpenError;if(Ne(!this.idbtrans),!e&&!n)switch(r&&r.name){case"DatabaseClosedError":throw new P.DatabaseClosed(r);case"MissingAPIError":throw new P.MissingAPI(r.message,r);default:throw new P.OpenFailed(r)}if(!this.active)throw new P.TransactionInactive;return Ne(this._completion._state===null),(e=this.idbtrans=e||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):n.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=K((s=>{Qe(s),this._reject(e.error)})),e.onabort=K((s=>{Qe(s),this.active&&this._reject(new P.Abort(e.error)),this.active=!1,this.on("abort").fire(s)})),e.oncomplete=K((()=>{this.active=!1,this._resolve(),"mutatedParts"in e&&pe.storagemutated.fire(e.mutatedParts)})),this}_promise(e,n,r){if(e==="readwrite"&&this.mode!=="readwrite")return N(new P.ReadOnly("Transaction is readonly"));if(!this.active)return N(new P.TransactionInactive);if(this._locked())return new M(((a,i)=>{this._blockedFuncs.push([()=>{this._promise(e,n,r).then(a,i)},A])}));if(r)return ue((()=>{var a=new M(((i,o)=>{this._lock();const l=n(i,o,this);l&&l.then&&l.then(i,o)}));return a.finally((()=>this._unlock())),a._lib=!0,a}));var s=new M(((a,i)=>{var o=n(a,i,this);o&&o.then&&o.then(a,i)}));return s._lib=!0,s}_root(){return this.parent?this.parent._root():this}waitFor(e){var n=this._root();const r=M.resolve(e);if(n._waitingFor)n._waitingFor=n._waitingFor.then((()=>r));else{n._waitingFor=r,n._waitingQueue=[];var s=n.idbtrans.objectStore(n.storeNames[0]);(function i(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(s.get(-1/0).onsuccess=i)})()}var a=n._waitingFor;return new M(((i,o)=>{r.then((l=>n._waitingQueue.push(K(i.bind(null,l)))),(l=>n._waitingQueue.push(K(o.bind(null,l))))).finally((()=>{n._waitingFor===a&&(n._waitingFor=null)}))}))}abort(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new P.Abort))}table(e){const n=this._memoizedTables||(this._memoizedTables={});if(G(n,e))return n[e];const r=this.schema[e];if(!r)throw new P.NotFound("Table "+e+" not part of transaction");const s=new this.db.Table(e,r,this);return s.core=this.db.core.table(e),n[e]=s,s}}function bn(t,e,n,r,s,a,i){return{name:t,keyPath:e,unique:n,multi:r,auto:s,compound:a,src:(n&&!i?"&":"")+(r?"*":"")+(s?"++":"")+Cr(e)}}function Cr(t){return typeof t=="string"?t:t?"["+[].join.call(t,"+")+"]":""}function Or(t,e,n){return{name:t,primKey:e,indexes:n,mappedClass:null,idxByName:Qn(n,(r=>[r.name,r]))}}let Ze=t=>{try{return t.only([[]]),Ze=()=>[[]],[[]]}catch{return Ze=()=>xe,xe}};function wn(t){return t==null?()=>{}:typeof t=="string"?(function(e){return e.split(".").length===1?r=>r[e]:r=>re(r,e)})(t):e=>re(e,t)}function Sr(t){return[].slice.call(t)}let Ys=0;function et(t){return t==null?":id":typeof t=="string"?t:`[${t.join("+")}]`}function Xs(t,e,n){function r(l){if(l.type===3)return null;if(l.type===4)throw new Error("Cannot convert never type to IDBKeyRange");const{lower:u,upper:c,lowerOpen:h,upperOpen:d}=l;return u===void 0?c===void 0?null:e.upperBound(c,!!d):c===void 0?e.lowerBound(u,!!h):e.bound(u,c,!!h,!!d)}const{schema:s,hasGetAll:a}=(function(l,u){const c=Sr(l.objectStoreNames);return{schema:{name:l.name,tables:c.map((h=>u.objectStore(h))).map((h=>{const{keyPath:d,autoIncrement:f}=h,v=V(d),y=d==null,m={},g={name:h.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:y,compound:v,keyPath:d,autoIncrement:f,unique:!0,extractKey:wn(d)},indexes:Sr(h.indexNames).map((p=>h.index(p))).map((p=>{const{name:w,unique:_,multiEntry:k,keyPath:E}=p,b={name:w,compound:V(E),keyPath:E,unique:_,multiEntry:k,extractKey:wn(E)};return m[et(E)]=b,b})),getIndexByKeyPath:p=>m[et(p)]};return m[":id"]=g.primaryKey,d!=null&&(m[et(d)]=g.primaryKey),g}))},hasGetAll:c.length>0&&"getAll"in u.objectStore(c[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}})(t,n),i=s.tables.map((l=>(function(u){const c=u.name;return{name:c,schema:u,mutate:function({trans:h,type:d,keys:f,values:v,range:y}){return new Promise(((m,g)=>{m=K(m);const p=h.objectStore(c),w=p.keyPath==null,_=d==="put"||d==="add";if(!_&&d!=="delete"&&d!=="deleteRange")throw new Error("Invalid operation type: "+d);const{length:k}=f||v||{length:1};if(f&&v&&f.length!==v.length)throw new Error("Given keys array must have same length as given values array.");if(k===0)return m({numFailures:0,failures:{},results:[],lastResult:void 0});let E;const b=[],C=[];let x=0;const S=j=>{++x,Qe(j)};if(d==="deleteRange"){if(y.type===4)return m({numFailures:x,failures:C,results:[],lastResult:void 0});y.type===3?b.push(E=p.clear()):b.push(E=p.delete(r(y)))}else{const[j,F]=_?w?[v,f]:[v,null]:[f,null];if(_)for(let R=0;R<k;++R)b.push(E=F&&F[R]!==void 0?p[d](j[R],F[R]):p[d](j[R])),E.onerror=S;else for(let R=0;R<k;++R)b.push(E=p[d](j[R])),E.onerror=S}const O=j=>{const F=j.target.result;b.forEach(((R,me)=>R.error!=null&&(C[me]=R.error))),m({numFailures:x,failures:C,results:d==="delete"?f:b.map((R=>R.result)),lastResult:F})};E.onerror=j=>{S(j),O(j)},E.onsuccess=O}))},getMany:({trans:h,keys:d})=>new Promise(((f,v)=>{f=K(f);const y=h.objectStore(c),m=d.length,g=new Array(m);let p,w=0,_=0;const k=b=>{const C=b.target;g[C._pos]=C.result,++_===w&&f(g)},E=Z(v);for(let b=0;b<m;++b)d[b]!=null&&(p=y.get(d[b]),p._pos=b,p.onsuccess=k,p.onerror=E,++w);w===0&&f(g)})),get:({trans:h,key:d})=>new Promise(((f,v)=>{f=K(f);const y=h.objectStore(c).get(d);y.onsuccess=m=>f(m.target.result),y.onerror=Z(v)})),query:(function(h){return d=>new Promise(((f,v)=>{f=K(f);const{trans:y,values:m,limit:g,query:p}=d,w=g===1/0?void 0:g,{index:_,range:k}=p,E=y.objectStore(c),b=_.isPrimaryKey?E:E.index(_.name),C=r(k);if(g===0)return f({result:[]});if(h){const x=m?b.getAll(C,w):b.getAllKeys(C,w);x.onsuccess=S=>f({result:S.target.result}),x.onerror=Z(v)}else{let x=0;const S=m||!("openKeyCursor"in b)?b.openCursor(C):b.openKeyCursor(C),O=[];S.onsuccess=j=>{const F=S.result;return F?(O.push(m?F.value:F.primaryKey),++x===g?f({result:O}):void F.continue()):f({result:O})},S.onerror=Z(v)}}))})(a),openCursor:function({trans:h,values:d,query:f,reverse:v,unique:y}){return new Promise(((m,g)=>{m=K(m);const{index:p,range:w}=f,_=h.objectStore(c),k=p.isPrimaryKey?_:_.index(p.name),E=v?y?"prevunique":"prev":y?"nextunique":"next",b=d||!("openKeyCursor"in k)?k.openCursor(r(w),E):k.openKeyCursor(r(w),E);b.onerror=Z(g),b.onsuccess=K((C=>{const x=b.result;if(!x)return void m(null);x.___id=++Ys,x.done=!1;const S=x.continue.bind(x);let O=x.continuePrimaryKey;O&&(O=O.bind(x));const j=x.advance.bind(x),F=()=>{throw new Error("Cursor not stopped")};x.trans=h,x.stop=x.continue=x.continuePrimaryKey=x.advance=()=>{throw new Error("Cursor not started")},x.fail=K(g),x.next=function(){let R=1;return this.start((()=>R--?this.continue():this.stop())).then((()=>this))},x.start=R=>{const me=new Promise(((q,D)=>{q=K(q),b.onerror=Z(D),x.fail=D,x.stop=ee=>{x.stop=x.continue=x.continuePrimaryKey=x.advance=F,q(ee)}})),ye=()=>{if(b.result)try{R()}catch(q){x.fail(q)}else x.done=!0,x.start=()=>{throw new Error("Cursor behind last entry")},x.stop()};return b.onsuccess=K((q=>{b.onsuccess=ye,ye()})),x.continue=S,x.continuePrimaryKey=O,x.advance=j,ye(),me},m(x)}),g)}))},count({query:h,trans:d}){const{index:f,range:v}=h;return new Promise(((y,m)=>{const g=d.objectStore(c),p=f.isPrimaryKey?g:g.index(f.name),w=r(v),_=w?p.count(w):p.count();_.onsuccess=K((k=>y(k.target.result))),_.onerror=Z(m)}))}}})(l))),o={};return i.forEach((l=>o[l.name]=l)),{stack:"dbcore",transaction:t.transaction.bind(t),table(l){if(!o[l])throw new Error(`Table '${l}' not found`);return o[l]},MIN_KEY:-1/0,MAX_KEY:Ze(e),schema:s}}function _n({_novip:t},e){const n=e.db,r=(function(s,a,{IDBKeyRange:i,indexedDB:o},l){return{dbcore:(function(c,h){return h.reduce(((d,{create:f})=>({...d,...f(d)})),c)})(Xs(a,i,l),s.dbcore)}})(t._middlewares,n,t._deps,e);t.core=r.dbcore,t.tables.forEach((s=>{const a=s.name;t.core.schema.tables.some((i=>i.name===a))&&(s.core=t.core.table(a),t[a]instanceof t.Table&&(t[a].core=s.core))}))}function Ct({_novip:t},e,n,r){n.forEach((s=>{const a=r[s];e.forEach((i=>{const o=Lt(i,s);(!o||"value"in o&&o.value===void 0)&&(i===t.Transaction.prototype||i instanceof t.Transaction?ne(i,s,{get(){return this.table(s)},set(l){Wn(this,s,{value:l,writable:!0,configurable:!0,enumerable:!0})}}):i[s]=new t.Table(s,a))}))}))}function xn({_novip:t},e){e.forEach((n=>{for(let r in n)n[r]instanceof t.Table&&delete n[r]}))}function Qs(t,e){return t._cfg.version-e._cfg.version}function Js(t,e,n,r){const s=t._dbSchema,a=t._createTransaction("readwrite",t._storeNames,s);a.create(n),a._completion.catch(r);const i=a._reject.bind(a),o=A.transless||A;ue((()=>{A.trans=a,A.transless=o,e===0?(B(s).forEach((l=>{kn(n,l,s[l].primKey,s[l].indexes)})),_n(t,n),M.follow((()=>t.on.populate.fire(a))).catch(i)):(function({_novip:l},u,c,h){const d=[],f=l._versions;let v=l._dbSchema=Mn(l,l.idbdb,h),y=!1;const m=f.filter((p=>p._cfg.version>=u));function g(){return d.length?M.resolve(d.shift()(c.idbtrans)).then(g):M.resolve()}return m.forEach((p=>{d.push((()=>{const w=v,_=p._cfg.dbschema;An(l,w,h),An(l,_,h),v=l._dbSchema=_;const k=Rr(w,_);k.add.forEach((b=>{kn(h,b[0],b[1].primKey,b[1].indexes)})),k.change.forEach((b=>{if(b.recreate)throw new P.Upgrade("Not yet support for changing primary key");{const C=h.objectStore(b.name);b.add.forEach((x=>En(C,x))),b.change.forEach((x=>{C.deleteIndex(x.name),En(C,x)})),b.del.forEach((x=>C.deleteIndex(x)))}}));const E=p._cfg.contentUpgrade;if(E&&p._cfg.version>u){_n(l,h),c._memoizedTables={},y=!0;let b=Jn(_);k.del.forEach((O=>{b[O]=w[O]})),xn(l,[l.Transaction.prototype]),Ct(l,[l.Transaction.prototype],B(b),b),c.schema=b;const C=Wt(E);let x;C&&Ie();const S=M.follow((()=>{if(x=E(c),x&&C){var O=ae.bind(null,null);x.then(O,O)}}));return x&&typeof x.then=="function"?M.resolve(x):S.then((()=>x))}})),d.push((w=>{(!y||!qs)&&(function(_,k){[].slice.call(k.db.objectStoreNames).forEach((E=>_[E]==null&&k.db.deleteObjectStore(E)))})(p._cfg.dbschema,w),xn(l,[l.Transaction.prototype]),Ct(l,[l.Transaction.prototype],l._storeNames,l._dbSchema),c.schema=l._dbSchema}))})),g().then((()=>{var p,w;w=h,B(p=v).forEach((_=>{w.db.objectStoreNames.contains(_)||kn(w,_,p[_].primKey,p[_].indexes)}))}))})(t,e,a,n).catch(i)}))}function Rr(t,e){const n={del:[],add:[],change:[]};let r;for(r in t)e[r]||n.del.push(r);for(r in e){const s=t[r],a=e[r];if(s){const i={name:r,def:a,recreate:!1,del:[],add:[],change:[]};if(""+(s.primKey.keyPath||"")!=""+(a.primKey.keyPath||"")||s.primKey.auto!==a.primKey.auto&&!xt)i.recreate=!0,n.change.push(i);else{const o=s.idxByName,l=a.idxByName;let u;for(u in o)l[u]||i.del.push(u);for(u in l){const c=o[u],h=l[u];c?c.src!==h.src&&i.change.push(h):i.add.push(h)}(i.del.length>0||i.add.length>0||i.change.length>0)&&n.change.push(i)}}else n.add.push([r,a])}return n}function kn(t,e,n,r){const s=t.db.createObjectStore(e,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach((a=>En(s,a))),s}function En(t,e){t.createIndex(e.name,e.keyPath,{unique:e.unique,multiEntry:e.multi})}function Mn(t,e,n){const r={};return lt(e.objectStoreNames,0).forEach((s=>{const a=n.objectStore(s);let i=a.keyPath;const o=bn(Cr(i),i||"",!1,!1,!!a.autoIncrement,i&&typeof i!="string",!0),l=[];for(let c=0;c<a.indexNames.length;++c){const h=a.index(a.indexNames[c]);i=h.keyPath;var u=bn(h.name,i,!!h.unique,!!h.multiEntry,!1,i&&typeof i!="string",!1);l.push(u)}r[s]=Or(s,o,l)})),r}function An({_novip:t},e,n){const r=n.db.objectStoreNames;for(let s=0;s<r.length;++s){const a=r[s],i=n.objectStore(a);t._hasGetAll="getAll"in i;for(let o=0;o<i.indexNames.length;++o){const l=i.indexNames[o],u=i.index(l).keyPath,c=typeof u=="string"?u:"["+lt(u).join("+")+"]";if(e[a]){const h=e[a].idxByName[c];h&&(h.name=l,delete e[a].idxByName[c],e[a].idxByName[l]=h)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&T.WorkerGlobalScope&&T instanceof T.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(t._hasGetAll=!1)}class Zs{_parseStoresSpec(e,n){B(e).forEach((r=>{if(e[r]!==null){var s=e[r].split(",").map(((i,o)=>{const l=(i=i.trim()).replace(/([&*]|\+\+)/g,""),u=/^\[/.test(l)?l.match(/^\[(.*)\]$/)[1].split("+"):l;return bn(l,u||null,/\&/.test(i),/\*/.test(i),/\+\+/.test(i),V(u),o===0)})),a=s.shift();if(a.multi)throw new P.Schema("Primary key cannot be multi-valued");s.forEach((i=>{if(i.auto)throw new P.Schema("Only primary key can be marked as autoIncrement (++)");if(!i.keyPath)throw new P.Schema("Index must have a name and cannot be an empty string")})),n[r]=Or(r,a,s)}}))}stores(e){const n=this.db;this._cfg.storesSource=this._cfg.storesSource?H(this._cfg.storesSource,e):e;const r=n._versions,s={};let a={};return r.forEach((i=>{H(s,i._cfg.storesSource),a=i._cfg.dbschema={},i._parseStoresSpec(s,a)})),n._dbSchema=a,xn(n,[n._allTables,n,n.Transaction.prototype]),Ct(n,[n._allTables,n,n.Transaction.prototype,this._cfg.tables],B(a),a),n._storeNames=B(a),this}upgrade(e){return this._cfg.contentUpgrade=Jt(this._cfg.contentUpgrade||I,e),this}}function Pn(t,e){let n=t._dbNamesDB;return n||(n=t._dbNamesDB=new Ee(kt,{addons:[],indexedDB:t,IDBKeyRange:e}),n.version(1).stores({dbnames:"name"})),n.table("dbnames")}function Cn(t){return t&&typeof t.databases=="function"}function On(t){return ue((function(){return A.letThrough=!0,t()}))}function ea(){var t;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var n=function(){return indexedDB.databases().finally(e)};t=setInterval(n,100),n()})).finally((function(){return clearInterval(t)})):Promise.resolve()}function ta(t){const e=t._state,{indexedDB:n}=t._deps;if(e.isBeingOpened||t.idbdb)return e.dbReadyPromise.then((()=>e.dbOpenError?N(e.dbOpenError):t));J&&(e.openCanceller._stackHolder=ve()),e.isBeingOpened=!0,e.dbOpenError=null,e.openComplete=!1;const r=e.openCanceller;function s(){if(e.openCanceller!==r)throw new P.DatabaseClosed("db.open() was cancelled")}let a=e.dbReadyResolve,i=null,o=!1;const l=()=>new M(((u,c)=>{if(s(),!n)throw new P.MissingAPI;const h=t.name,d=e.autoSchema?n.open(h):n.open(h,Math.round(10*t.verno));if(!d)throw new P.MissingAPI;d.onerror=Z(c),d.onblocked=K(t._fireOnBlocked),d.onupgradeneeded=K((f=>{if(i=d.transaction,e.autoSchema&&!t._options.allowEmptyDB){d.onerror=Qe,i.abort(),d.result.close();const y=n.deleteDatabase(h);y.onsuccess=y.onerror=K((()=>{c(new P.NoSuchDatabase(`Database ${h} doesnt exist`))}))}else{i.onerror=Z(c);var v=f.oldVersion>Math.pow(2,62)?0:f.oldVersion;o=v<1,t._novip.idbdb=d.result,Js(t,v/10,i,c)}}),c),d.onsuccess=K((()=>{i=null;const f=t._novip.idbdb=d.result,v=lt(f.objectStoreNames);if(v.length>0)try{const m=f.transaction((y=v).length===1?y[0]:y,"readonly");e.autoSchema?(function({_novip:g},p,w){g.verno=p.version/10;const _=g._dbSchema=Mn(0,p,w);g._storeNames=lt(p.objectStoreNames,0),Ct(g,[g._allTables],B(_),_)})(t,f,m):(An(t,t._dbSchema,m),(function(g,p){const w=Rr(Mn(0,g.idbdb,p),g._dbSchema);return!(w.add.length||w.change.some((_=>_.add.length||_.change.length)))})(t,m)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),_n(t,m)}catch{}var y;We.push(t),f.onversionchange=K((m=>{e.vcFired=!0,t.on("versionchange").fire(m)})),f.onclose=K((m=>{t.on("close").fire(m)})),o&&(function({indexedDB:m,IDBKeyRange:g},p){!Cn(m)&&p!==kt&&Pn(m,g).put({name:p}).catch(I)})(t._deps,h),u()}),c)})).catch((u=>u&&u.name==="UnknownError"&&e.PR1398_maxLoop>0?(e.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),l()):M.reject(u)));return M.race([r,(typeof navigator>"u"?M.resolve():ea()).then(l)]).then((()=>(s(),e.onReadyBeingFired=[],M.resolve(On((()=>t.on.ready.fire(t.vip)))).then((function u(){if(e.onReadyBeingFired.length>0){let c=e.onReadyBeingFired.reduce(Jt,I);return e.onReadyBeingFired=[],M.resolve(On((()=>c(t.vip)))).then(u)}}))))).finally((()=>{e.onReadyBeingFired=null,e.isBeingOpened=!1})).then((()=>t)).catch((u=>{e.dbOpenError=u;try{i&&i.abort()}catch{}return r===e.openCanceller&&t._close(),N(u)})).finally((()=>{e.openComplete=!0,a()}))}function Sn(t){var e=a=>t.next(a),n=s(e),r=s((a=>t.throw(a)));function s(a){return i=>{var o=a(i),l=o.value;return o.done?l:l&&typeof l.then=="function"?l.then(n,r):V(l)?Promise.all(l).then(n,r):n(l)}}return s(e)()}function na(t,e,n){var r=arguments.length;if(r<2)throw new P.InvalidArgument("Too few arguments");for(var s=new Array(r-1);--r;)s[r-1]=arguments[r];return n=s.pop(),[t,Zn(s),n]}function Ir(t,e,n,r,s){return M.resolve().then((()=>{const a=A.transless||A,i=t._createTransaction(e,n,t._dbSchema,r),o={trans:i,transless:a};if(r)i.idbtrans=r.idbtrans;else try{i.create(),t._state.PR1398_maxLoop=3}catch(h){return h.name===Qt.InvalidState&&t.isOpen()&&--t._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),t._close(),t.open().then((()=>Ir(t,e,n,null,s)))):N(h)}const l=Wt(s);let u;l&&Ie();const c=M.follow((()=>{if(u=s.call(i,i),u)if(l){var h=ae.bind(null,null);u.then(h,h)}else typeof u.next=="function"&&typeof u.throw=="function"&&(u=Sn(u))}),o);return(u&&typeof u.then=="function"?M.resolve(u).then((h=>i.active?h:N(new P.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn")))):c.then((()=>u))).then((h=>(r&&i._resolve(),i._completion.then((()=>h))))).catch((h=>(i._reject(h),N(h))))}))}function Ot(t,e,n){const r=V(t)?t.slice():[t];for(let s=0;s<n;++s)r.push(e);return r}const ra={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(t){return{...t,table(e){const n=t.table(e),{schema:r}=n,s={},a=[];function i(c,h,d){const f=et(c),v=s[f]=s[f]||[],y=c==null?0:typeof c=="string"?1:c.length,m=h>0,g={...d,isVirtual:m,keyTail:h,keyLength:y,extractKey:wn(c),unique:!m&&d.unique};return v.push(g),g.isPrimaryKey||a.push(g),y>1&&i(y===2?c[0]:c.slice(0,y-1),h+1,d),v.sort(((p,w)=>p.keyTail-w.keyTail)),g}const o=i(r.primaryKey.keyPath,0,r.primaryKey);s[":id"]=[o];for(const c of r.indexes)i(c.keyPath,0,c);function l(c){const h=c.query.index;return h.isVirtual?{...c,query:{index:h,range:(d=c.query.range,f=h.keyTail,{type:d.type===1?2:d.type,lower:Ot(d.lower,d.lowerOpen?t.MAX_KEY:t.MIN_KEY,f),lowerOpen:!0,upper:Ot(d.upper,d.upperOpen?t.MIN_KEY:t.MAX_KEY,f),upperOpen:!0})}}:c;var d,f}return{...n,schema:{...r,primaryKey:o,indexes:a,getIndexByKeyPath:function(c){const h=s[et(c)];return h&&h[0]}},count:c=>n.count(l(c)),query:c=>n.query(l(c)),openCursor(c){const{keyTail:h,isVirtual:d,keyLength:f}=c.query.index;return d?n.openCursor(l(c)).then((v=>v&&(function(y){return Object.create(y,{continue:{value:function(g){g!=null?y.continue(Ot(g,c.reverse?t.MAX_KEY:t.MIN_KEY,h)):c.unique?y.continue(y.key.slice(0,f).concat(c.reverse?t.MIN_KEY:t.MAX_KEY,h)):y.continue()}},continuePrimaryKey:{value(g,p){y.continuePrimaryKey(Ot(g,t.MAX_KEY,h),p)}},primaryKey:{get:()=>y.primaryKey},key:{get(){const g=y.key;return f===1?g[0]:g.slice(0,f)}},value:{get:()=>y.value}})})(v))):n.openCursor(c)}}}}}};function Rn(t,e,n,r){return n=n||{},r=r||"",B(t).forEach((s=>{if(G(e,s)){var a=t[s],i=e[s];if(typeof a=="object"&&typeof i=="object"&&a&&i){const o=Ut(a);o!==Ut(i)?n[r+s]=e[s]:o==="Object"?Rn(a,i,n,r+s+"."):a!==i&&(n[r+s]=e[s])}else a!==i&&(n[r+s]=e[s])}else n[r+s]=void 0})),B(e).forEach((s=>{G(t,s)||(n[r+s]=e[s])})),n}const sa={stack:"dbcore",name:"HooksMiddleware",level:2,create:t=>({...t,table(e){const n=t.table(e),{primaryKey:r}=n.schema;return{...n,mutate(a){const i=A.trans,{deleting:o,creating:l,updating:u}=i.table(e).hook;switch(a.type){case"add":if(l.fire===I)break;return i._promise("readwrite",(()=>c(a)),!0);case"put":if(l.fire===I&&u.fire===I)break;return i._promise("readwrite",(()=>c(a)),!0);case"delete":if(o.fire===I)break;return i._promise("readwrite",(()=>c(a)),!0);case"deleteRange":if(o.fire===I)break;return i._promise("readwrite",(()=>(function(d){return h(d.trans,d.range,1e4)})(a)),!0)}return n.mutate(a);function c(d){const f=A.trans,v=d.keys||(function(y,m){return m.type==="delete"?m.keys:m.keys||m.values.map(y.extractKey)})(r,d);if(!v)throw new Error("Keys missing");return(d=d.type==="add"||d.type==="put"?{...d,keys:v}:{...d}).type!=="delete"&&(d.values=[...d.values]),d.keys&&(d.keys=[...d.keys]),(function(y,m,g){return m.type==="add"?Promise.resolve([]):y.getMany({trans:m.trans,keys:g,cache:"immutable"})})(n,d,v).then((y=>{const m=v.map(((g,p)=>{const w=y[p],_={onerror:null,onsuccess:null};if(d.type==="delete")o.fire.call(_,g,w,f);else if(d.type==="add"||w===void 0){const k=l.fire.call(_,g,d.values[p],f);g==null&&k!=null&&(g=k,d.keys[p]=g,r.outbound||X(d.values[p],r.keyPath,g))}else{const k=Rn(w,d.values[p]),E=u.fire.call(_,k,g,w,f);if(E){const b=d.values[p];Object.keys(E).forEach((C=>{G(b,C)?b[C]=E[C]:X(b,C,E[C])}))}}return _}));return n.mutate(d).then((({failures:g,results:p,numFailures:w,lastResult:_})=>{for(let k=0;k<v.length;++k){const E=p?p[k]:v[k],b=m[k];E==null?b.onerror&&b.onerror(g[k]):b.onsuccess&&b.onsuccess(d.type==="put"&&y[k]?d.values[k]:E)}return{failures:g,results:p,numFailures:w,lastResult:_}})).catch((g=>(m.forEach((p=>p.onerror&&p.onerror(g))),Promise.reject(g))))}))}function h(d,f,v){return n.query({trans:d,values:!1,query:{index:r,range:f},limit:v}).then((({result:y})=>c({type:"delete",keys:y,trans:d}).then((m=>m.numFailures>0?Promise.reject(m.failures[0]):y.length<v?{failures:[],numFailures:0,lastResult:void 0}:h(d,{...f,lower:y[y.length-1],lowerOpen:!0},v)))))}}}}})};function Tr(t,e,n){try{if(!e||e.keys.length<t.length)return null;const r=[];for(let s=0,a=0;s<e.keys.length&&a<t.length;++s)U(e.keys[s],t[a])===0&&(r.push(n?$e(e.values[s]):e.values[s]),++a);return r.length===t.length?r:null}catch{return null}}const aa={stack:"dbcore",level:-1,create:t=>({table:e=>{const n=t.table(e);return{...n,getMany:r=>{if(!r.cache)return n.getMany(r);const s=Tr(r.keys,r.trans._cache,r.cache==="clone");return s?M.resolve(s):n.getMany(r).then((a=>(r.trans._cache={keys:r.keys,values:r.cache==="clone"?$e(a):a},a)))},mutate:r=>(r.type!=="add"&&(r.trans._cache=null),n.mutate(r))}}})};function In(t){return!("from"in t)}const oe=function(t,e){if(!this){const n=new oe;return t&&"d"in t&&H(n,t),n}H(this,arguments.length?{d:1,from:t,to:arguments.length>1?e:t}:{d:0})};function tt(t,e,n){const r=U(e,n);if(isNaN(r))return;if(r>0)throw RangeError();if(In(t))return H(t,{from:e,to:n,d:1});const s=t.l,a=t.r;if(U(n,t.from)<0)return s?tt(s,e,n):t.l={from:e,to:n,d:1,l:null,r:null},Dr(t);if(U(e,t.to)>0)return a?tt(a,e,n):t.r={from:e,to:n,d:1,l:null,r:null},Dr(t);U(e,t.from)<0&&(t.from=e,t.l=null,t.d=a?a.d+1:1),U(n,t.to)>0&&(t.to=n,t.r=null,t.d=t.l?t.l.d+1:1);const i=!t.r;s&&!t.l&&St(t,s),a&&i&&St(t,a)}function St(t,e){In(e)||(function n(r,{from:s,to:a,l:i,r:o}){tt(r,s,a),i&&n(r,i),o&&n(r,o)})(t,e)}function ia(t,e){const n=Tn(e);let r=n.next();if(r.done)return!1;let s=r.value;const a=Tn(t);let i=a.next(s.from),o=i.value;for(;!r.done&&!i.done;){if(U(o.from,s.to)<=0&&U(o.to,s.from)>=0)return!0;U(s.from,o.from)<0?s=(r=n.next(o.from)).value:o=(i=a.next(s.from)).value}return!1}function Tn(t){let e=In(t)?null:{s:0,n:t};return{next(n){const r=arguments.length>0;for(;e;)switch(e.s){case 0:if(e.s=1,r)for(;e.n.l&&U(n,e.n.from)<0;)e={up:e,n:e.n.l,s:1};else for(;e.n.l;)e={up:e,n:e.n.l,s:1};case 1:if(e.s=2,!r||U(n,e.n.to)<=0)return{value:e.n,done:!1};case 2:if(e.n.r){e.s=3,e={up:e,n:e.n.r,s:0};continue}case 3:e=e.up}return{done:!0}}}}function Dr(t){var e,n;const r=(((e=t.r)===null||e===void 0?void 0:e.d)||0)-(((n=t.l)===null||n===void 0?void 0:n.d)||0),s=r>1?"r":r<-1?"l":"";if(s){const a=s==="r"?"l":"r",i={...t},o=t[s];t.from=o.from,t.to=o.to,t[s]=o[s],i[s]=o[a],t[a]=i,i.d=Kr(i)}t.d=Kr(t)}function Kr({r:t,l:e}){return(t?e?Math.max(t.d,e.d):t.d:e?e.d:0)+1}Pe(oe.prototype,{add(t){return St(this,t),this},addKey(t){return tt(this,t,t),this},addKeys(t){return t.forEach((e=>tt(this,e,e))),this},[Gt](){return Tn(this)}});const oa={stack:"dbcore",level:0,create:t=>{const e=t.schema.name,n=new oe(t.MIN_KEY,t.MAX_KEY);return{...t,table:r=>{const s=t.table(r),{schema:a}=s,{primaryKey:i}=a,{extractKey:o,outbound:l}=i,u={...s,mutate:d=>{const f=d.trans,v=f.mutatedParts||(f.mutatedParts={}),y=E=>{const b=`idb://${e}/${r}/${E}`;return v[b]||(v[b]=new oe)},m=y(""),g=y(":dels"),{type:p}=d;let[w,_]=d.type==="deleteRange"?[d.range]:d.type==="delete"?[d.keys]:d.values.length<50?[[],d.values]:[];const k=d.trans._cache;return s.mutate(d).then((E=>{if(V(w)){p!=="delete"&&(w=E.results),m.addKeys(w);const b=Tr(w,k);b||p==="add"||g.addKeys(w),(b||_)&&(function(C,x,S,O){function j(F){const R=C(F.name||"");function me(q){return q!=null?F.extractKey(q):null}const ye=q=>F.multiEntry&&V(q)?q.forEach((D=>R.addKey(D))):R.addKey(q);(S||O).forEach(((q,D)=>{const ee=S&&me(S[D]),Fe=O&&me(O[D]);U(ee,Fe)!==0&&(ee!=null&&ye(ee),Fe!=null&&ye(Fe))}))}x.indexes.forEach(j)})(y,a,b,_)}else if(w){const b={from:w.lower,to:w.upper};g.add(b),m.add(b)}else m.add(n),g.add(n),a.indexes.forEach((b=>y(b.name).add(n)));return E}))}},c=({query:{index:d,range:f}})=>{var v,y;return[d,new oe((v=f.lower)!==null&&v!==void 0?v:t.MIN_KEY,(y=f.upper)!==null&&y!==void 0?y:t.MAX_KEY)]},h={get:d=>[i,new oe(d.key)],getMany:d=>[i,new oe().addKeys(d.keys)],count:c,query:c,openCursor:c};return B(h).forEach((d=>{u[d]=function(f){const{subscr:v}=A;if(v){const y=_=>{const k=`idb://${e}/${r}/${_}`;return v[k]||(v[k]=new oe)},m=y(""),g=y(":dels"),[p,w]=h[d](f);if(y(p.name||"").add(w),!p.isPrimaryKey){if(d!=="count"){const _=d==="query"&&l&&f.values&&s.query({...f,values:!1});return s[d].apply(this,arguments).then((k=>{if(d==="query"){if(l&&f.values)return _.then((({result:b})=>(m.addKeys(b),k)));const E=f.values?k.result.map(o):k.result;f.values?m.addKeys(E):g.addKeys(E)}else if(d==="openCursor"){const E=k,b=f.values;return E&&Object.create(E,{key:{get:()=>(g.addKey(E.primaryKey),E.key)},primaryKey:{get(){const C=E.primaryKey;return g.addKey(C),C}},value:{get:()=>(b&&m.addKey(E.primaryKey),E.value)}})}return k}))}g.add(n)}}return s[d].apply(this,arguments)}})),u}}}};class Ee{constructor(e,n){this._middlewares={},this.verno=0;const r=Ee.dependencies;this._options=n={addons:Ee.addons,autoOpen:!0,indexedDB:r.indexedDB,IDBKeyRange:r.IDBKeyRange,...n},this._deps={indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange};const{addons:s}=n;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;const a={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:I,dbReadyPromise:null,cancelOpen:I,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};var i;a.dbReadyPromise=new M((o=>{a.dbReadyResolve=o})),a.openCanceller=new M(((o,l)=>{a.cancelOpen=l})),this._state=a,this.name=e,this.on=Ye(this,"populate","blocked","versionchange","close",{ready:[Jt,I]}),this.on.ready.subscribe=Yn(this.on.ready.subscribe,(o=>(l,u)=>{Ee.vip((()=>{const c=this._state;if(c.openComplete)c.dbOpenError||M.resolve().then(l),u&&o(l);else if(c.onReadyBeingFired)c.onReadyBeingFired.push(l),u&&o(l);else{o(l);const h=this;u||o((function d(){h.on.ready.unsubscribe(l),h.on.ready.unsubscribe(d)}))}}))})),this.Collection=(i=this,Xe(Ls.prototype,(function(o,l){this.db=i;let u=_r,c=null;if(l)try{u=l()}catch(v){c=v}const h=o._ctx,d=h.table,f=d.hook.reading.fire;this._ctx={table:d,index:h.index,isPrimKey:!h.index||d.schema.primKey.keyPath&&h.index===d.schema.primKey.name,range:u,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:c,or:h.or,valueMapper:f!==Ve?f:null}}))),this.Table=(function(o){return Xe(zs.prototype,(function(l,u,c){this.db=o,this._tx=c,this.name=l,this.schema=u,this.hook=o._allTables[l]?o._allTables[l].hook:Ye(null,{creating:[Rs,I],reading:[Ss,Ve],updating:[Ts,I],deleting:[Is,I]})}))})(this),this.Transaction=(function(o){return Xe(Ws.prototype,(function(l,u,c,h,d){this.db=o,this.mode=l,this.storeNames=u,this.schema=c,this.chromeTransactionDurability=h,this.idbtrans=null,this.on=Ye(this,"complete","error","abort"),this.parent=d||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new M(((f,v)=>{this._resolve=f,this._reject=v})),this._completion.then((()=>{this.active=!1,this.on.complete.fire()}),(f=>{var v=this.active;return this.active=!1,this.on.error.fire(f),this.parent?this.parent._reject(f):v&&this.idbtrans&&this.idbtrans.abort(),N(f)}))}))})(this),this.Version=(function(o){return Xe(Zs.prototype,(function(l){this.db=o,this._cfg={version:l,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}}))})(this),this.WhereClause=(function(o){return Xe(Pr.prototype,(function(l,u,c){this.db=o,this._ctx={table:l,index:u===":id"?null:u,or:c};const h=o._deps.indexedDB;if(!h)throw new P.MissingAPI;this._cmp=this._ascending=h.cmp.bind(h),this._descending=(d,f)=>h.cmp(f,d),this._max=(d,f)=>h.cmp(d,f)>0?d:f,this._min=(d,f)=>h.cmp(d,f)<0?d:f,this._IDBKeyRange=o._deps.IDBKeyRange}))})(this),this.on("versionchange",(o=>{o.newVersion>0?console.warn(`Another connection wants to upgrade database '${this.name}'. Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.name}'. Closing db now to resume the delete request.`),this.close()})),this.on("blocked",(o=>{!o.newVersion||o.newVersion<o.oldVersion?console.warn(`Dexie.delete('${this.name}') was blocked`):console.warn(`Upgrade '${this.name}' blocked by other connection holding version ${o.oldVersion/10}`)})),this._maxKey=Ze(n.IDBKeyRange),this._createTransaction=(o,l,u,c)=>new this.Transaction(o,l,u,this._options.chromeTransactionDurability,c),this._fireOnBlocked=o=>{this.on("blocked").fire(o),We.filter((l=>l.name===this.name&&l!==this&&!l._state.vcFired)).map((l=>l.on("versionchange").fire(o)))},this.use(ra),this.use(sa),this.use(oa),this.use(aa),this.vip=Object.create(this,{_vip:{value:!0}}),s.forEach((o=>o(this)))}version(e){if(isNaN(e)||e<.1)throw new P.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new P.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);const n=this._versions;var r=n.filter((s=>s._cfg.version===e))[0];return r||(r=new this.Version(e),n.push(r),n.sort(Qs),r.stores({}),this._state.autoSchema=!1,r)}_whenReady(e){return this.idbdb&&(this._state.openComplete||A.letThrough||this._vip)?e():new M(((n,r)=>{if(this._state.openComplete)return r(new P.DatabaseClosed(this._state.dbOpenError));if(!this._state.isBeingOpened){if(!this._options.autoOpen)return void r(new P.DatabaseClosed);this.open().catch(I)}this._state.dbReadyPromise.then(n,r)})).then(e)}use({stack:e,create:n,level:r,name:s}){s&&this.unuse({stack:e,name:s});const a=this._middlewares[e]||(this._middlewares[e]=[]);return a.push({stack:e,create:n,level:r??10,name:s}),a.sort(((i,o)=>i.level-o.level)),this}unuse({stack:e,name:n,create:r}){return e&&this._middlewares[e]&&(this._middlewares[e]=this._middlewares[e].filter((s=>r?s.create!==r:!!n&&s.name!==n))),this}open(){return ta(this)}_close(){const e=this._state,n=We.indexOf(this);if(n>=0&&We.splice(n,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}e.dbReadyPromise=new M((r=>{e.dbReadyResolve=r})),e.openCanceller=new M(((r,s)=>{e.cancelOpen=s}))}close(){this._close();const e=this._state;this._options.autoOpen=!1,e.dbOpenError=new P.DatabaseClosed,e.isBeingOpened&&e.cancelOpen(e.dbOpenError)}delete(){const e=arguments.length>0,n=this._state;return new M(((r,s)=>{const a=()=>{this.close();var i=this._deps.indexedDB.deleteDatabase(this.name);i.onsuccess=K((()=>{(function({indexedDB:o,IDBKeyRange:l},u){!Cn(o)&&u!==kt&&Pn(o,l).delete(u).catch(I)})(this._deps,this.name),r()})),i.onerror=Z(s),i.onblocked=this._fireOnBlocked};if(e)throw new P.InvalidArgument("Arguments not allowed in db.delete()");n.isBeingOpened?n.dbReadyPromise.then(a):a()}))}backendDB(){return this.idbdb}isOpen(){return this.idbdb!==null}hasBeenClosed(){const e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"}hasFailed(){return this._state.dbOpenError!==null}dynamicallyOpened(){return this._state.autoSchema}get tables(){return B(this._allTables).map((e=>this._allTables[e]))}transaction(){const e=na.apply(this,arguments);return this._transaction.apply(this,e)}_transaction(e,n,r){let s=A.trans;s&&s.db===this&&e.indexOf("!")===-1||(s=null);const a=e.indexOf("?")!==-1;let i,o;e=e.replace("!","").replace("?","");try{if(o=n.map((u=>{var c=u instanceof this.Table?u.name:u;if(typeof c!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return c})),e=="r"||e===pn)i=pn;else{if(e!="rw"&&e!=mn)throw new P.InvalidArgument("Invalid transaction mode: "+e);i=mn}if(s){if(s.mode===pn&&i===mn){if(!a)throw new P.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");s=null}s&&o.forEach((u=>{if(s&&s.storeNames.indexOf(u)===-1){if(!a)throw new P.SubTransaction("Table "+u+" not included in parent transaction.");s=null}})),a&&s&&!s.active&&(s=null)}}catch(u){return s?s._promise(null,((c,h)=>{h(u)})):N(u)}const l=Ir.bind(null,this,i,o,s,r);return s?s._promise(i,l,"lock"):A.trans?Te(A.transless,(()=>this._whenReady(l))):this._whenReady(l)}table(e){if(!G(this._allTables,e))throw new P.InvalidTable(`Table ${e} does not exist`);return this._allTables[e]}}const la=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable";class ca{constructor(e){this._subscribe=e}subscribe(e,n,r){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:n,complete:r})}[la](){return this}}function Fr(t,e){return B(e).forEach((n=>{St(t[n]||(t[n]=new oe),e[n])})),t}function ua(t){let e,n=!1;const r=new ca((s=>{const a=Wt(t);let i=!1,o={},l={};const u={get closed(){return i},unsubscribe:()=>{i=!0,pe.storagemutated.unsubscribe(f)}};s.start&&s.start(u);let c=!1,h=!1;function d(){return B(l).some((y=>o[y]&&ia(o[y],l[y])))}const f=y=>{Fr(o,y),d()&&v()},v=()=>{if(c||i)return;o={};const y={},m=(function(g){a&&Ie();const p=()=>ue(t,{subscr:g,trans:null}),w=A.trans?Te(A.transless,p):p();return a&&w.then(ae,ae),w})(y);h||(pe(Je,f),h=!0),c=!0,Promise.resolve(m).then((g=>{n=!0,e=g,c=!1,i||(d()?v():(o={},l=y,s.next&&s.next(g)))}),(g=>{c=!1,n=!1,s.error&&s.error(g),u.unsubscribe()}))};return v(),u}));return r.hasValue=()=>n,r.getValue=()=>e,r}let Dn;try{Dn={indexedDB:T.indexedDB||T.mozIndexedDB||T.webkitIndexedDB||T.msIndexedDB,IDBKeyRange:T.IDBKeyRange||T.webkitIDBKeyRange}}catch{Dn={indexedDB:null,IDBKeyRange:null}}const Me=Ee;function Rt(t){let e=le;try{le=!0,pe.storagemutated.fire(t)}finally{le=e}}Pe(Me,{...ut,delete:t=>new Me(t,{addons:[]}).delete(),exists:t=>new Me(t,{addons:[]}).open().then((e=>(e.close(),!0))).catch("NoSuchDatabaseError",(()=>!1)),getDatabaseNames(t){try{return(function({indexedDB:e,IDBKeyRange:n}){return Cn(e)?Promise.resolve(e.databases()).then((r=>r.map((s=>s.name)).filter((s=>s!==kt)))):Pn(e,n).toCollection().primaryKeys()})(Me.dependencies).then(t)}catch{return N(new P.MissingAPI)}},defineClass:()=>function(t){H(this,t)},ignoreTransaction:t=>A.trans?Te(A.transless,t):t(),vip:On,async:function(t){return function(){try{var e=Sn(t.apply(this,arguments));return e&&typeof e.then=="function"?e:M.resolve(e)}catch(n){return N(n)}}},spawn:function(t,e,n){try{var r=Sn(t.apply(n,e||[]));return r&&typeof r.then=="function"?r:M.resolve(r)}catch(s){return N(s)}},currentTransaction:{get:()=>A.trans||null},waitFor:function(t,e){const n=M.resolve(typeof t=="function"?Me.ignoreTransaction(t):t).timeout(e||6e4);return A.trans?A.trans.waitFor(n):n},Promise:M,debug:{get:()=>J,set:t=>{tr(t,t==="dexie"?()=>!0:wr)}},derive:Ce,extend:H,props:Pe,override:Yn,Events:Ye,on:pe,liveQuery:ua,extendObservabilitySet:Fr,getByKeyPath:re,setByKeyPath:X,delByKeyPath:function(t,e){typeof e=="string"?X(t,e,void 0):"length"in e&&[].map.call(e,(function(n){X(t,n,void 0)}))},shallowClone:Jn,deepClone:$e,getObjectDiff:Rn,cmp:U,asap:Xn,minKey:fn,addons:[],connections:We,errnames:Qt,dependencies:Dn,semVer:vr,version:vr.split(".").map((t=>parseInt(t))).reduce(((t,e,n)=>t+e/Math.pow(10,2*n)))}),Me.maxKey=Ze(Me.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(pe(Je,(t=>{if(!le){let e;xt?(e=document.createEvent("CustomEvent"),e.initCustomEvent(fe,!0,!0,t)):e=new CustomEvent(fe,{detail:t}),le=!0,dispatchEvent(e),le=!1}})),addEventListener(fe,(({detail:t})=>{le||Rt(t)})));let le=!1;if(typeof BroadcastChannel<"u"){const t=new BroadcastChannel(fe);typeof t.unref=="function"&&t.unref(),pe(Je,(e=>{le||t.postMessage(e)})),t.onmessage=e=>{e.data&&Rt(e.data)}}else if(typeof self<"u"&&typeof navigator<"u"){pe(Je,(e=>{try{le||(typeof localStorage<"u"&&localStorage.setItem(fe,JSON.stringify({trig:Math.random(),changedParts:e})),typeof self.clients=="object"&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach((n=>n.postMessage({type:fe,changedParts:e}))))}catch{}})),typeof addEventListener<"u"&&addEventListener("storage",(e=>{if(e.key===fe){const n=JSON.parse(e.newValue);n&&Rt(n.changedParts)}}));const t=self.document&&navigator.serviceWorker;t&&t.addEventListener("message",(function({data:e}){e&&e.type===fe&&Rt(e.changedParts)}))}M.rejectionMapper=function(t,e){if(!t||t instanceof Se||t instanceof TypeError||t instanceof SyntaxError||!t.name||!ar[t.name])return t;var n=new ar[t.name](e||t.message,t);return"stack"in t&&ne(n,"stack",{get:function(){return this.inner.stack}}),n},tr(J,wr);let It;const ha=new Uint8Array(16);function da(){if(!It&&(It=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!It))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return It(ha)}const $=[];for(let t=0;t<256;++t)$.push((t+256).toString(16).slice(1));function fa(t,e=0){return $[t[e+0]]+$[t[e+1]]+$[t[e+2]]+$[t[e+3]]+"-"+$[t[e+4]]+$[t[e+5]]+"-"+$[t[e+6]]+$[t[e+7]]+"-"+$[t[e+8]]+$[t[e+9]]+"-"+$[t[e+10]]+$[t[e+11]]+$[t[e+12]]+$[t[e+13]]+$[t[e+14]]+$[t[e+15]]}var jr={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Kn(t,e,n){if(jr.randomUUID&&!t)return jr.randomUUID();t=t||{};const r=t.random||(t.rng||da)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,fa(r)}class pa extends Ee{images;cameraPoses;modelCheckpoints;constructor(){super("NeRFDatabase"),this.version(1).stores({images:"++id, timestamp, filename",cameraPoses:"++id, imageId, timestamp",modelCheckpoints:"++id, modelVersion, timestamp"})}}const Y=new pa;class ma{async saveImage(e,n){const r=Kn(),s={id:r,timestamp:Date.now(),filename:n||(e instanceof File?e.name:`image-${r}`),mimeType:e.type,data:e};return await Y.images.add(s),r}async getImages(){return Y.images.toArray()}async getImageById(e){return Y.images.get(e)}async saveCameraPose(e,n){const r=Kn(),s={id:r,imageId:e,poseMatrix:n,timestamp:Date.now()};return await Y.cameraPoses.add(s),r}async getCameraPoses(){return Y.cameraPoses.toArray()}async getCameraPosesByImageId(e){return Y.cameraPoses.where("imageId").equals(e).toArray()}async saveModelCheckpoint(e,n,r,s,a){const i=Kn(),o={id:i,modelVersion:n,timestamp:Date.now(),weights:e,trainingEpoch:r,loss:s,metrics:a};return await Y.modelCheckpoints.add(o),i}async getLatestModelCheckpoint(){const e=await Y.modelCheckpoints.orderBy("modelVersion").reverse().first();if(!e)return;const n=e.modelVersion,r=await Y.modelCheckpoints.where("modelVersion").equals(n).toArray();if(r.length>0)return r.sort((s,a)=>a.timestamp-s.timestamp),r[0]}async clearTable(e){await Y.table(e).clear()}async clearAllData(){await Promise.all([Y.images.clear(),Y.cameraPoses.clear(),Y.modelCheckpoints.clear()])}}const Tt=new ma;class ya{deviceOrientationToCameraMatrix(e,n,r){const s=Bt(),a=Q(),i=e*Math.PI/180,o=n*Math.PI/180,l=r*Math.PI/180;Gn(a,o,l,i,"zxy");const u=vs(Q(),a),c=Gn(Q(),180,0,0);return gs(u,u,c),Nt(s,u,ot(0,0,0)),s}opencvRTToCameraMatrix(e,n){const r=Bt(),s=zn(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]),a=ot(n[0],n[1],n[2]),i=jt();ts(i,s);const o=te();Hn(o,a,i),ls(o,o);const l=zn(1,0,0,0,-1,0,0,0,-1),u=jt();ns(u,l,i);const c=te();return Hn(c,o,l),Nt(r,Un(Q(),u),c),r}}const Br=new ya;async function ga(t){return new Promise(async(e,n)=>{if(typeof cv<"u"&&cv.Mat){console.log("OpenCV.js already loaded."),e();return}try{const r=await fetch(t);if(!r.ok){n(new Error(`Failed to fetch OpenCV.js: ${r.statusText}`));return}const s=await r.text();self.eval(s);const a=setInterval(()=>{typeof cv<"u"&&cv.onRuntimeInitialized?cv.onRuntimeInitialized=()=>{console.log("OpenCV.js loaded and initialized."),clearInterval(a),e()}:typeof cv<"u"&&(console.log("OpenCV.js loaded (assumed ready)."),clearInterval(a),e())},100)}catch(r){n(r)}})}class va{isCvLoaded=!1;BRIGHTNESS_MIN_THRESHOLD=50;BRIGHTNESS_MAX_THRESHOLD=200;SHARPNESS_THRESHOLD=100;REDUNDANCY_MATCH_RATIO_THRESHOLD=.8;constructor(){this.init()}async init(){try{await ga("/opencv.js"),this.isCvLoaded=!0,console.log("PoseEstimationWorker: OpenCV.js ready.")}catch(e){console.error("PoseEstimationWorker: Failed to load OpenCV.js",e),this.isCvLoaded=!1}}ensureCvLoaded(){if(!this.isCvLoaded)throw new Error("OpenCV.js is not loaded or initialized. Call init() first.")}async estimateRelativePoses(e,n,r,s){if(this.ensureCvLoaded(),console.log(`Estimating relative poses for ${e} and ${n}`),!r||r.length!==9)throw new Error("Invalid cameraMatrix: Must be a Float32Array of 9 elements (3x3 matrix).");if(s&&s.length!==4&&s.length!==5)throw new Error("Invalid distCoeffs: Must be a Float32Array of 4 or 5 elements.");const a=await Tt.getImageById(e),i=await Tt.getImageById(n);if(!a||!i)throw new Error("One or both images not found in the database.");const o=cv.matFromArray(3,3,cv.CV_32F,Array.from(r)),l=s?cv.matFromArray(1,s.length,cv.CV_32F,Array.from(s)):new cv.Mat;let u=new cv.Mat,c=new cv.Mat,h=new cv.Mat,d=new cv.Mat,f=new cv.KeyPointVector,v=new cv.KeyPointVector,y=new cv.Mat,m=new cv.Mat,g=new cv.DMatchVector,p=new cv.DMatchVector,w=new cv.Mat,_=new cv.Mat,k=new cv.Mat,E=new cv.Mat,b=new cv.Mat,C=new cv.Mat,x,S;try{const O=await a.data.arrayBuffer();u=cv.imdecode(new cv.Mat(1,O.byteLength,cv.CV_8U,new Uint8Array(O)),cv.IMREAD_COLOR);const j=await i.data.arrayBuffer();if(c=cv.imdecode(new cv.Mat(1,j.byteLength,cv.CV_8U,new Uint8Array(j)),cv.IMREAD_COLOR),u.empty()||c.empty())throw new Error("Failed to decode images.");if(cv.cvtColor(u,h,cv.COLOR_RGBA2GRAY,0),cv.cvtColor(c,d,cv.COLOR_RGBA2GRAY,0),x=new cv.ORB,x.detectAndCompute(h,new cv.Mat,f,y),x.detectAndCompute(d,new cv.Mat,v,m),y.empty()||m.empty())throw new Error("No descriptors found for one or both images.");S=new cv.BFMatcher(cv.NORM_HAMMING,!0),S.match(y,m,g);const F=g.size();if(F<8)throw new Error(`Not enough matches (${F}) found for essential matrix estimation.`);const R=[];for(let D=0;D<F;D++)R.push(g.get(D));R.sort((D,ee)=>D.distance-ee.distance);for(let D=0;D<Math.min(200,F*.5);D++)p.push_back(R[D]);if(p.size()<8)throw new Error(`Not enough good matches (${p.size()}) after filtering for essential matrix estimation.`);w=new cv.Mat(p.size(),2,cv.CV_32F),_=new cv.Mat(p.size(),2,cv.CV_32F);for(let D=0;D<p.size();D++){const ee=p.get(D),Fe=f.get(ee.queryIdx).pt,Nr=v.get(ee.trainIdx).pt;w.data32F[D*2]=Fe.x,w.data32F[D*2+1]=Fe.y,_.data32F[D*2]=Nr.x,_.data32F[D*2+1]=Nr.y}if(k=cv.findEssentialMat(w,_,o,cv.RANSAC,.999,1,C),k.empty())throw new Error("Failed to estimate Essential Matrix.");if(cv.recoverPose(k,w,_,o,E,b,C),E.empty()||b.empty())throw new Error("Failed to recover pose from Essential Matrix.");const me=Array.from(E.data32F),ye=Array.from(b.data32F),q=Br.opencvRTToCameraMatrix(me,ye);return await Tt.saveCameraPose(n,new Float32Array(q)),console.log(`Saved relative pose for image ${n} (relative to ${e}).`),{image1Id:e,image2Id:n,poseMatrix:new Float32Array(q)}}catch(O){throw console.error("Error during pose estimation:",O),O}finally{u.delete(),c.delete(),h.delete(),d.delete(),f.delete(),v.delete(),y.delete(),m.delete(),g.delete(),p.delete(),w.delete(),_.delete(),k.delete(),E.delete(),b.delete(),C.delete(),o.delete(),l.delete(),x&&x.delete(),S&&S.delete()}}async integrateDeviceOrientation(e,n,r,s){console.log(`Integrating device orientation for image ${e}: alpha=${n}, beta=${r}, gamma=${s}`);const a=Br.deviceOrientationToCameraMatrix(n,r,s);return await Tt.saveCameraPose(e,new Float32Array(a)),console.log(`Saved device orientation pose for image ${e}.`),{imageId:e,poseMatrix:new Float32Array(a)}}async triangulatePoints(e,n,r,s){if(this.ensureCvLoaded(),console.log("Triangulating 3D points from 2D correspondences."),!e||e.length%2!==0||e.length===0)throw new Error("Invalid points1: Must be a non-empty Float32Array with an even number of elements (N*2).");if(!n||n.length%2!==0||n.length===0)throw new Error("Invalid points2: Must be a non-empty Float32Array with an even number of elements (N*2).");if(e.length!==n.length)throw new Error("points1 and points2 must have the same number of elements.");if(!r||r.length!==12)throw new Error("Invalid P1: Must be a Float32Array of 12 elements (3x4 projection matrix).");if(!s||s.length!==12)throw new Error("Invalid P2: Must be a Float32Array of 12 elements (3x4 projection matrix).");const a=e.length/2;let i=new cv.Mat(a,2,cv.CV_32F,e),o=new cv.Mat(a,2,cv.CV_32F,n),l=new cv.Mat(3,4,cv.CV_32F,r),u=new cv.Mat(3,4,cv.CV_32F,s),c=new cv.Mat;try{cv.triangulatePoints(l,u,i,o,c);const h=new Float32Array(a*3);for(let d=0;d<a;d++){const f=c.data32F[d*4],v=c.data32F[d*4+1],y=c.data32F[d*4+2],m=c.data32F[d*4+3];Math.abs(m)<1e-6?(h[d*3]=NaN,h[d*3+1]=NaN,h[d*3+2]=NaN,console.warn(`Triangulated point ${d} has a near-zero w-component, indicating a point at infinity or invalid triangulation.`)):(h[d*3]=f/m,h[d*3+1]=v/m,h[d*3+2]=y/m)}return console.log(`Successfully triangulated ${a} 3D points.`),h}catch(h){throw console.error("Error during 3D point triangulation:",h),h}finally{i.delete(),o.delete(),l.delete(),u.delete(),c.delete()}}async refineGlobalPoses(e){if(console.log(`Refining ${e.length} global poses using iterative smoothing.`),console.warn("Note: This is NOT full Bundle Adjustment. For production use, consider:"),console.warn("- COLMAP integration for robust BA"),console.warn("- Ceres Solver via WebAssembly"),console.warn("- External pre-processing of poses"),e.length<=1)return e;const n=e.map(a=>({imageId:a.imageId,poseMatrix:Ln(a.poseMatrix)})),r=5,s=.2;for(let a=0;a<r;a++){const i=n.map(o=>({imageId:o.imageId,poseMatrix:Ln(o.poseMatrix)}));for(let o=0;o<n.length;o++){if(o===0)continue;const l=i[o].poseMatrix;let u=te(),c=Q();$t(u,l),qt(c,l);let h=[],d=[];const f=i[o-1].poseMatrix;let v=te(),y=Q();if($t(v,f),qt(y,f),h.push(v),d.push(y),o+1<n.length){const m=i[o+1].poseMatrix;let g=te(),p=Q();$t(g,m),qt(p,m),h.push(g),d.push(p)}if(h.length>0){let m=te();for(const k of h)is(m,m,k);os(m,m,1/h.length);let g=bs(d[0]);for(let k=1;k<d.length;k++)je(g,g,d[k],1/(k+1));zt(g,g);let p=te();hs(p,u,m,s);let w=Q();je(w,c,g,s);let _=Bt();Nt(_,w,p),rs(n[o].poseMatrix,_)}}}return console.log("PoseEstimationWorker.refineGlobalPoses: Completed basic iterative smoothing for global poses. This is NOT a full Bundle Adjustment and serves as a placeholder for more sophisticated optimization. It assumes a sequential order of poses for neighbor identification."),n.map(a=>({imageId:a.imageId,poseMatrix:new Float32Array(a.poseMatrix)}))}async validateBatchPhotos(e){this.ensureCvLoaded(),console.log(`Validating batch of ${e.length} photos...`);const n=[],r=new Map,s=new Map,a=new Map,i=new cv.ORB,o=new cv.BFMatcher(cv.NORM_HAMMING,!0);try{for(const l of e){let u=new cv.Mat,c=new cv.Mat,h=new cv.KeyPointVector,d=new cv.Mat;try{if(u=cv.imdecode(new cv.Mat(1,l.data.byteLength,cv.CV_8U,new Uint8Array(l.data)),cv.IMREAD_COLOR),u.empty()){n.push({imageId:l.id,filename:l.filename,brightness:0,sharpness:0,isValid:!1,messages:["Failed to decode image."]});continue}cv.cvtColor(u,c,cv.COLOR_RGBA2GRAY,0),i.detectAndCompute(c,new cv.Mat,h,d),r.set(l.id,u),s.set(l.id,c),a.set(l.id,{descriptors:d,keypoints:h})}catch(f){console.error(`Error processing image ${l.filename} for features:`,f),n.push({imageId:l.id,filename:l.filename,brightness:0,sharpness:0,isValid:!1,messages:[`Error processing image: ${f.message}`]}),u.delete(),c.delete(),h.delete(),d.delete()}}for(const l of e){const u=[];let c=!0,h=0,d=0,f,v;const y=s.get(l.id),m=a.get(l.id);if(!y||!m){if(n.find(C=>C.imageId===l.id))continue;n.push({imageId:l.id,filename:l.filename,brightness:0,sharpness:0,isValid:!1,messages:["Image data or features not available."]});continue}h=cv.mean(y)[0],(h<this.BRIGHTNESS_MIN_THRESHOLD||h>this.BRIGHTNESS_MAX_THRESHOLD)&&(u.push(`Brightness (${h.toFixed(2)}) is outside optimal range (${this.BRIGHTNESS_MIN_THRESHOLD}-${this.BRIGHTNESS_MAX_THRESHOLD}).`),c=!1);let p=new cv.Mat,w=new cv.Mat,_=new cv.Mat;try{cv.Laplacian(y,p,cv.CV_64F),cv.meanStdDev(p,w,_),d=_.data64F[0]**2,d<this.SHARPNESS_THRESHOLD&&(u.push(`Sharpness (${d.toFixed(2)}) is low. Image might be blurry (threshold: ${this.SHARPNESS_THRESHOLD}).`),c=!1)}catch(b){console.error(`Error calculating sharpness for ${l.filename}:`,b),u.push(`Error calculating sharpness: ${b.message}`),c=!1}finally{p.delete(),w.delete(),_.delete()}const k=m.descriptors,E=m.keypoints;if(k.empty())u.push("No features found for redundancy check.");else{let b=0,C;for(const x of e){if(l.id===x.id)continue;const S=a.get(x.id);if(!S||S.descriptors.empty())continue;let O=new cv.DMatchVector;try{o.match(k,S.descriptors,O);const j=O.size(),F=Math.min(E.size(),S.keypoints.size());if(F>0){const R=j/F;R>b&&(b=R,C=x.id)}}catch(j){console.warn(`Error comparing features between ${l.filename} and ${x.filename}:`,j)}finally{O.delete()}}f=b,b>this.REDUNDANCY_MATCH_RATIO_THRESHOLD&&(u.push(`Image is highly redundant with image ID ${C} (match ratio: ${(b*100).toFixed(1)}%, threshold: ${(this.REDUNDANCY_MATCH_RATIO_THRESHOLD*100).toFixed(1)}%).`),v=C,c=!1)}n.push({imageId:l.id,filename:l.filename,brightness:h,sharpness:d,redundancyScore:f,redundantWith:v,isValid:c,messages:u})}}catch(l){throw console.error("Error during batch photo validation:",l),l}finally{i.delete(),o.delete(),r.forEach(l=>l.delete()),s.forEach(l=>l.delete()),a.forEach(l=>{l.descriptors.delete(),l.keypoints.delete()})}return console.log("Batch photo validation complete."),n}}Kt(new va)})();
